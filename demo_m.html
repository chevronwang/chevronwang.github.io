<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="utf-8">
  <meta name="description" content="MEETING reference app">
  <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1">
  <meta itemprop="description" content="Video chat using the reference ARTVC application">
  <meta itemprop="name" content="MEETING">
  <meta name="mobile-web-app-capable" content="yes">
  <meta id="theme-color" name="theme-color" content="#1e1e1e">
  <base target="_blank">
  <title>MCU DEMO Mobile</title>
  <link rel="stylesheet" type="text/css" href="./lib/dialogue.css">

  <style>
    .hiddenForMobile {
      display: none;
    }

    .icon {
      width: 1em;
      height: 1em;
      vertical-align: -0.15em;
      fill: currentColor;
      overflow: hidden;
    }

    .header {
      text-align: center;
      border-bottom: 1px solid #aaa;
      float: left;
      width: 100%;
      box-sizing: border-box;
    }

    body {
      padding: 0;
      margin: 0;
    }

    label {
      width: 100px;
      display: inline-block;
    }

    #callstart {
      border-bottom: 1px solid #aaa;
    }

    .css-3d-btn {}

    html,
    body {
      height: 100%;
      width: 100%;
      font-size: 16px;
    }

    body {
      box-sizing: border-box;
    }

    input,
    select {
      height: 25px;
      margin-top: 5px;
      font-size: 16px;
    }

    #videos {
      position: relative;
      display: none;
      height: 100%;
    }

    .publishVideo {
      position: absolute;
      height: 100%;
      width: 100%;
    }

    .publishVideo.side {
      width: 30%;
      height: 30%;
      z-index: 99;
      top: 0;
      left: 0;
    }

    #room_id {
      width: 50%;
    }

    #rtoken {
      margin-top: 5px;
    }

    #rtokenLabel {
      margin-top: 5px;
    }

    #publish_video1 {
      height: 100%;
      width: 100%;
    }

    .subscribeVideo {
      position: absolute;
      height: 100%;
      width: 100%;
    }

    .subscribeVideo.side {
      width: 30%;
      height: 30%;
      z-index: 99;
      top: 0;
      left: 0;
    }


    .icons-m {
      position: absolute;
      bottom: 120px;
      left: 0;
      margin: 0;
      z-index: 999;
    }

    .roomInfo {
      position: absolute;
      bottom: 20px;
      left: 0px;
      z-index: 100;
    }

    .roomInfo span {
      background-color: transparent;
      border: none;
      color: whitesmoke;
      font-size: 16px;
    }

    #icons1 {
      margin-left: 20px;
      margin-top: 10px;
    }

    #icons1.active svg {
      transform: translateX(0);
    }

    #icons2 {
      position: absolute;
      right: 20px;
      bottom: 30px;
      width: 50px;
      height: 50px;
    }

    #invitee {
      height: 20px;
      width: 140px;
    }

    .info {
      padding-left: 30px;
    }
  </style>
</head>

<body>
  <!-- <label type="text" style="color: #3A6EA5">&nbsp;请选择业务模式</label> &nbsp;&nbsp;&nbsp;&nbsp;
    <button id="duet" onclick="duteMode()" class="button blue">&nbsp;&nbsp;双人通话&nbsp;&nbsp;</button>
    <button id="multiplayer" onclick="multiplayerMode()" class="button blue">&nbsp;&nbsp;多人通话&nbsp;&nbsp;</button> -->
  <header class="header">音视频通话</header>
  <div class="info">
    <table cellspacing="0" cellpadding="0">
      <!--注意事项-->
      <!--  <tr>
                <td>
                    <button class="button green rarrow" onclick="show('a0')" style="width:180px">
                        【注意事项及使用说明】
                    </button>
                    <div id="a0" style="display: block">
                        <div id="videos" border="2px">
                            &nbsp; 1、请使用
                            <label type="text" class="css-text-color">chrome浏览器，67版本以上</label> , 必须使用
                            <label type="text" class="css-text-color">https</label> ;
                            <br>&nbsp; 2、使用步骤:
                            <label type="text" class="css-text-color">【连接】--&gt;</label>

                            <label type="text" class="css-text-color">【创建房间】/【邀请加入】/【加入房间】--&gt;</label>

                            <label type="text" class="css-text-color">【发布音视频】/【订阅音视频】--&gt;</label>

                            <label type="text" class="css-text-color">【取消发布音视频】/【取消订阅音视频】</label>
                            <br> &nbsp;
                            <button id="downloadLog" class="css-3d-btn" onclick="downloadLog()">
                                &nbsp;&nbsp;日志上报&nbsp;&nbsp;
                            </button>
                        </div>
                    </div>
                </td>
            </tr>-->

      <!-- 建立连接 -->
      <tr>
        <td>
          <!--  <button class="button green rarrow" onclick="show('a1')" style="width:110px">【建立连接】-->
          </button>
          <div id="a1">
            <div id="callstart">
              <label text="biz_name:">biz_name:</label>
              <input type="text" id="biz_name" value="demo" style="width:80px;" /></br>
              <label text="appId:">appId:</label>
              <input type="text" id="appId" value="default" style="width:80px;" /></br>
              <label text="workspaceId:">workspaceId:</label>
              <input type="text" id="workspaceId" value="default" style="width:70px;" /></br>
              <label text="uid:">uid:</label>
              <input type="text" id="uid" style="width:150px;" /> </br>
              <label text="room_server">房间服务器:&nbsp;&nbsp;</label>
              <select name="select" id="select_room">
                <option value="wss://mrtc.mpaas.cn-hangzhou.aliyuncs.com/ws">&nbsp;非金生产(mpaas)&nbsp;</option>
                <option value="wss://room.mrtc-fin.cn-shanghai.aliyuncs.com/ws">&nbsp;金区生产(mpaas)&nbsp;</option>
              </select> </br>
              <label text="new_sign:">签名:</label>
              <input type="text" id="new_sign" style="width:100px;" value="signature" placeholder="请输入签名" /></br>
              <button id="connectButton" class="css-3d-btn">&nbsp;&nbsp;连接&nbsp;&nbsp;</button> &nbsp;
              <button id="disconnectButton" class="css-3d-btn">&nbsp;&nbsp;断开&nbsp;&nbsp;</button> &nbsp;
              <!-- <button id="httpsFixButton" class="css-3d-btn">&nbsp;&nbsp;https修复&nbsp;&nbsp;</button> &nbsp;-->
              <label type="text">&nbsp;&nbsp;连接状态:</label>
              <label id="conn_state" type="text" class="css-text-color">断开</label>
            </div>
          </div>

        </td>
      </tr>

      <tr>
        <td>
          <div id="a2">
            <!-- 房间 -->
            <label text="room_id:" style="width: 140px;">room_id(房间号):</label>
            <input type="text" id="room_id" placeholder="请输入房间号" /></br>
            <label text="rtoken:" id="rtokenLabel" style="width: 140px;">rtoken(房间密码):</label>
            <input type="text" id="rtoken" value="123" placeholder="请输入密码" style="width:100px;" /></br>
            <label text="engine" class="css-text-color hiddenForMobile">engine:</label>
            <select name="engine" id="engine" class="xla_k css-text-color hiddenForMobile">
              <option value="0" selected>&nbsp;&nbsp;alipay&nbsp;&nbsp;</option>
              <option value="1">&nbsp;&nbsp;aliyun&nbsp;&nbsp;</option>
            </select>
            <label text="publish_device" class="css-text-color hiddenForMobile">发布类型:</label>
            <select name="publish_device" id="publish_device" class="xla_k css-text-color hiddenForMobile"
              onchange="publishDeviceChange1()">
              <option selected value="1">&nbsp;&nbsp;1.摄像头&nbsp;&nbsp;</option>
              <option value="2">&nbsp;&nbsp;2.共享桌面&nbsp;&nbsp;</option>
              <option value="3">&nbsp;&nbsp;3.共享文件&nbsp;&nbsp;</option>
              <option value="4">&nbsp;&nbsp;4.共享html区域&nbsp;&nbsp;</option>
            </select>
            <label text="auto_publish_subscribe" class="css-text-color hiddenForMobile">自动发布订阅:</label>
            <select name="auto_publish_subscribe" id="auto_publish_subscribe"
              class="xla_k css-text-color hiddenForMobile">
              <option value="1">&nbsp;&nbsp;1.自动订阅&nbsp;&nbsp;</option>
              <option value="2">&nbsp;&nbsp;2.自动发布&nbsp;&nbsp;</option>
              <option value="3" selected>&nbsp;&nbsp;3.自动发布/订阅&nbsp;&nbsp;</option>
              <option value="4">&nbsp;&nbsp;4.手动发布/订阅&nbsp;&nbsp;</option>
            </select>
            <label for="defaultRecord" class="hiddenForMobile">自动开启录制</label><input id="defaultRecord" type="checkbox"
              class="hiddenForMobile">
            <label for="recordStrongDepend" class="hiddenForMobile"><input id="recordStrongDepend" type="checkbox"
                checked>录制强依赖</label>
            <!-- 音视频 -->
            <label text="publish_tag" class="hidden">发布tag:</label><input id="publish_tag" class="hidden" type="text"
              value="VIDEO_SOURCE_CAMERA">
            <label text="media_type" class="hiddenForMobile">发布流类型:</label>
            <select name="media_type" id="media_type" class="xla_k hiddenForMobile">
              <option value="1" selected>&nbsp;&nbsp;1.音视频&nbsp;&nbsp;</option>
              <option value="2">&nbsp;&nbsp;2.纯音频&nbsp;&nbsp;</option>
              <option value="3">&nbsp;&nbsp;3.纯视频&nbsp;&nbsp;</option>
            </select>
            <label text="codec_type" class="hiddenForMobile">编码方式:</label>
            <select name="select_codec" id="select_codec" class="xla_k hiddenForMobile">
              <option value="H264">&nbsp;&nbsp;H264&nbsp;&nbsp;
              </option>
              <option value="VP8">&nbsp;&nbsp;VP8&nbsp;&nbsp;</option>
            </select>
            <label text="codec_type" class="hiddenForMobile">协议类型:</label>
            <select name="proto_type" id="proto_type" class="xla_k hiddenForMobile">
              <option value="all">&nbsp;&nbsp;TCP & UDP&nbsp;&nbsp;
              </option>
              <option value="tcp">&nbsp;&nbsp;ONLY TCP&nbsp;&nbsp;
              </option>
              <option value="udp">&nbsp;&nbsp;ONLY UDP&nbsp;&nbsp;
              </option>
            </select>
            <label text="video_profile_type" style="width: 140px;">分辨率:</label>
            <select name="select" id="video_profile_type" class="xla_k" style="width: 110px;">
              <option value="1">&nbsp;720p, 1280x720, 16:9&nbsp;</option>
              <option value="3" selected>&nbsp;360p, 640x360, 16:9&nbsp;</option>
            </select>
            <label text="bitrate" style="display:none">发布弱网告警(带宽评估):</label>
            <input type="text" id="weak_bitrate" value="200" style="width:60px;display:none" /> &nbsp;
            <label text="bitrate" style="display:none">发布弱网告警(视频丢包率):</label>
            <input type="text" id="weak_video_lost_rate" value="20" style="width:60px;display:none" /> &nbsp;
            <label text="bitrate" style="display:none">发布弱网码率告警(音频丢包率):</label>
            <input type="text" id="weak_audio_lost_rate" value="20" style="width:60px;display:none" /> &nbsp;
            <label text="bitrate" style="display:none">订阅弱网码率告警:</label>
            <input type="text" id="remote_weak_bitrate" value="200" style="width:60px;display:none" /> &nbsp;
            <label class="hiddenForMobile">
              <input id="aspect_ratio_strong_depend" type="checkbox" class="hiddenForMobile">自定义横纵比</label>
            <label text="aspect_ratio" class="hiddenForMobile">横纵比:</label>
            <select name="select" id="aspectRatio" class="xla_k hiddenForMobile">
              <option value="1" selected>&nbsp;4:3&nbsp;</option>
              <option value="2">&nbsp;16:9&nbsp;</option>
            </select>
            <label text="codec_type" class="hiddenForMobile">传输方式:</label>
            <select name="transport_" id="transport_" class="xla_k hiddenForMobile">
              <option selected value="all">&nbsp;&nbsp;all&nbsp;&nbsp;
              </option>
              <option value="relay">&nbsp;&nbsp;relay&nbsp;&nbsp;
              </option>
            </select>
            <label text="default_turn_server" style="display:none">自定义中转服务器:</label>
            <input type="text" id="default_turn_server" style="width:120px;display:none" placeholder="请输入中转服务" />
            <label for="videoSource" class="hidden">camera source: </label><select id="videoSource"
              class="hidden"></select> &nbsp;&nbsp;&nbsp;
            <label for="audioSource" style="display:none">microphone
              source: </label><select id="audioSource" style="display:none"></select> &nbsp;&nbsp;&nbsp;
            <label for="audioOutput" style="display:none">audio output</label><select id="audioOutput"
              style="display:none"></select></br>
            <button id="createButton" class="css-3d-btn">&nbsp;&nbsp;创建房间&nbsp;&nbsp;</button>
            <button id="joinButton" class="css-3d-btn">&nbsp;&nbsp;加入房间&nbsp;&nbsp;</button>
            <button id="endButton" class="css-3d-btn hidden">&nbsp;&nbsp;退出房间&nbsp;&nbsp;</button>
            </br>
            <label type="text" style="width: 120px;">是否在房间中:</label>
            <label id="join_room_state" type="text" class="css-text-color">否</label> </br>

          </div>
        </td>
      </tr>
    </table>
  </div>
  <div id="videos">
    <div class="publishVideo">
      <video id="publish_video1" autoplay muted="true" webkit-playsinline="true" playsinline="true"
        style="object-fit: cover;"></video>
      <label id="publish_media_stat1" class="css-text-color hiddenForMobile" type="text"></label>
      <label type="text" id="streamId_text" class="hiddenForMobile">streamId:</label>
      <label id="publish_streamId1" class="css-text-color hiddenForMobile" type="text"></label>
    </div>
    <div class="subscribeVideo">
      <video id="video0" autoplay muted width="100%" height="100%" webkit-playsinline="true" playsinline="true"
        style="object-fit: cover;">
        video
      </video>
      <audio id="audio0" autoplay>音频</audio>
      <video id="video99" autoplay muted="true" width="100%" height="480" hidden>
        video
      </video>
      <audio id="audio99" autoplay hidden>音频</audio>
      <br>
      <label type="text" id="subscribe_feedId_text0" class="hiddenForMobile" hidden>&nbsp;&nbsp;feedId:</label>
      <label id="feedId0" class="css-text-color hiddenForMobile" type="text"></label>
      <br>
      <label type="text" id="subscribe_streamId_text0" hidden class="hiddenForMobile">&nbsp;&nbsp;streamId:</label>
      <label id="subscribe_streamId0" class="css-text-color hiddenForMobile" type="text"></label>
    </div>
    <div class="roomInfo">
      <span>uid:</span><span id="uid_m"></span></br>
      <span>房间号：</span><span id="room_id_m"></span></br>
      <span>密码：</span><span id="rtoken_m"></span></br>
      <input type="text" id="invitee" class="mcu-placeholder" placeholder="请填入被邀请者uid" />
      <label text="engine" class="css-text-color hidden">推送渠道:</label>
      <select name="channel_type" id="invitation_channel_type" class="xla_k hidden css-text-color">
        <option value="0" selected>&nbsp;&nbsp;WEB&nbsp;&nbsp;</option>
        <option value="1">&nbsp;&nbsp;ALIPAY&nbsp;&nbsp;</option>
      </select>
      <input type="text" id="invitation_link" class="mcu-placeholder hidden" placeholder="请填入邀请参数" />
      <button id="inviteButton" class="css-3d-btn">&nbsp;&nbsp;邀请加入房间&nbsp;&nbsp;</button>
      <label id="invite_state" type="text" style="color:rgba(219, 87, 51, 1)"></label>
    </div>
    <div id="icons1" class="active icons-m">
      <svg id="switchCamera" aria-hidden="true" style="font-size:48px;" xmlns="http://www.w3.org/2000/svg" class="icon"
        viewBox="0 0 1024 1024" version="1.1">

        <path fill="#ffffff"
          d="M791.616 256.341333h104.448a85.674667 85.674667 0 0 1 85.568 85.269334l1.706667 469.12a84.650667 84.650667 0 0 1-85.077334 85.056l-767.936-1.813334a85.973333 85.973333 0 0 1-85.674666-85.504l-1.685334-466.816a84.928 84.928 0 0 1 84.992-85.312h130.410667c11.861333 0 25.792-8.618667 31.125333-19.221333l34.858667-69.376c10.496-20.906667 38.144-38.08 61.674667-38.186667l276.928-1.344c23.637333-0.128 51.2 16.853333 61.824 37.952l35.904 71.253334c5.290667 10.496 19.114667 18.922667 30.933333 18.922666z m0 42.666667c-27.882667 0-56.469333-17.472-69.034667-42.410667l-35.904-71.253333c-3.349333-6.656-16.128-14.506667-23.509333-14.464l-276.906667 1.344c-7.466667 0.021333-20.48 8.106667-23.786666 14.677333l-34.858667 69.376c-12.586667 25.024-41.237333 42.730667-69.248 42.730667H127.957333c-23.466667 0-42.410667 18.986667-42.325333 42.474667l1.706667 466.837333a43.306667 43.306667 0 0 0 43.093333 42.986667l767.914667 1.813333a41.984 41.984 0 0 0 42.304-42.24l-1.685334-469.12a43.008 43.008 0 0 0-42.88-42.752h-104.469333z m-341.205333 52.416a192.085333 192.085333 0 0 0-53.205334 335.829333 21.333333 21.333333 0 0 1-25.536 34.197334A234.304 234.304 0 0 1 277.333333 533.333333c0-113.557333 80.682667-208.298667 187.84-229.973333l-32.256-32.277333a21.333333 21.333333 0 0 1 30.165334-30.165334L542.165333 320l-79.082666 79.082667a21.333333 21.333333 0 0 1-30.165334-30.165334l17.493334-17.493333z m70.634666 373.696a192 192 0 0 0 68.778667-367.36 21.333333 21.333333 0 1 1 17.301333-38.997333A234.666667 234.666667 0 0 1 746.666667 533.333333c0 126.698667-100.416 229.952-225.984 234.517334l27.733333 27.733333a21.333333 21.333333 0 0 1-30.165333 30.165333L439.168 746.666667l79.082667-79.082667a21.333333 21.333333 0 0 1 30.165333 30.165333l-27.370667 27.370667z" />
      </svg>
      <svg id="mute-audio" width="48" height="48" xmlns="http://www.w3.org/2000/svg"
        xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="-10 -10 68 68">
        <title>title</title>
        <circle cx="24" cy="24" r="34">
          <title>Mute audio</title>
        </circle>

        <path class="on" transform="scale(0.6), translate(17,18)"
          d="M38 22h-3.4c0 1.49-.31 2.87-.87 4.1l2.46 2.46C37.33 26.61 38 24.38 38 22zm-8.03.33c0-.11.03-.22.03-.33V10c0-3.32-2.69-6-6-6s-6 2.68-6 6v.37l11.97 11.96zM8.55 6L6 8.55l12.02 12.02v1.44c0 3.31 2.67 6 5.98 6 .45 0 .88-.06 1.3-.15l3.32 3.32c-1.43.66-3 1.03-4.62 1.03-5.52 0-10.6-4.2-10.6-10.2H10c0 6.83 5.44 12.47 12 13.44V42h4v-6.56c1.81-.27 3.53-.9 5.08-1.81L39.45 42 42 39.46 8.55 6z"
          fill="white" />
        <path class="off" transform="scale(0.6), translate(17,18)"
          d="M24 28c3.31 0 5.98-2.69 5.98-6L30 10c0-3.32-2.68-6-6-6-3.31 0-6 2.68-6 6v12c0 3.31 2.69 6 6 6zm10.6-6c0 6-5.07 10.2-10.6 10.2-5.52 0-10.6-4.2-10.6-10.2H10c0 6.83 5.44 12.47 12 13.44V42h4v-6.56c6.56-.97 12-6.61 12-13.44h-3.4z"
          fill="white" />
      </svg>
      <svg id="mute-video" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="48"
        height="48" viewbox="-10 -10 68 68">
        <circle cx="24" cy="24" r="34">
          <title>Mute video</title>
        </circle>

        <path class="on" transform="scale(0.6), translate(17,16)"
          d="M40 8H15.64l8 8H28v4.36l1.13 1.13L36 16v12.36l7.97 7.97L44 36V12c0-2.21-1.79-4-4-4zM4.55 2L2 4.55l4.01 4.01C4.81 9.24 4 10.52 4 12v24c0 2.21 1.79 4 4 4h29.45l4 4L44 41.46 4.55 2zM12 16h1.45L28 30.55V32H12V16z"
          fill="white" />
        <path class="off" transform="scale(0.6), translate(17,16)"
          d="M40 8H8c-2.21 0-4 1.79-4 4v24c0 2.21 1.79 4 4 4h32c2.21 0 4-1.79 4-4V12c0-2.21-1.79-4-4-4zm-4 24l-8-6.4V32H12V16h16v6.4l8-6.4v16z"
          fill="white" />
      </svg>
      <svg id="hangup" class="" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="48"
        height="48" viewBox="-10 -10 68 68">
        <circle cx="24" cy="24" r="34">
          <title>Hangup</title>
        </circle>
        <path transform="scale(0.7), translate(11,10)"
          d="M24 18c-3.21 0-6.3.5-9.2 1.44v6.21c0 .79-.46 1.47-1.12 1.8-1.95.98-3.74 2.23-5.33 3.7-.36.35-.85.57-1.4.57-.55 0-1.05-.22-1.41-.59L.59 26.18c-.37-.37-.59-.87-.59-1.42 0-.55.22-1.05.59-1.42C6.68 17.55 14.93 14 24 14s17.32 3.55 23.41 9.34c.37.36.59.87.59 1.42 0 .55-.22 1.05-.59 1.41l-4.95 4.95c-.36.36-.86.59-1.41.59-.54 0-1.04-.22-1.4-.57-1.59-1.47-3.38-2.72-5.33-3.7-.66-.33-1.12-1.01-1.12-1.8v-6.21C30.3 18.5 27.21 18 24 18z"
          fill="white"></path>
      </svg>
    </div>

  </div>
  <script src="./lib/iconfont.js"></script>
  <script type="text/javascript" src="https://gw.alipayobjects.com/os/lib/jquery/3.5.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.2"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix@2.0"></script>

  <script src="./lib/getMediaInfo.js"></script>
  <script src="./lib/adapter.js"></script>
  <script src="./lib/eruda.js"></script>

  <!-- file引用 -->
  <script src="./lib/mcu.js"></script>
  <script src="./lib/meeting_desk_stream.js"></script>
  <script src="./lib/meeting_html_stream.js"></script>
  <script src="./lib/meeting_file_stream.js"></script>
  <script src="./lib/meeting_im.js"></script>
  <script src="./lib/meeting_vod.js"></script>
  <script src="./lib/meeting_invite.js"></script>
  <script src="./lib/client_record.js"></script>
  <script src="./lib/remote_record.js"></script>
  <script src="./lib/meeting_camera_stream.js"></script>
  <script src="./lib/meeting_api.js"></script>


  <script type="module">
    eruda.init();
    let facingMode = 'user';
    document.addEventListener("WeixinJSBridgeReady", function () {
      if (navigator.userAgent.indexOf("Android") == -1 && navigator.userAgent.indexOf("iPhone") > -1) {
        document.getElementById('publish_video1').play();
        document.getElementById('video0').play();
      }
    }, false);
    function show(c_Str) {
      if (document.all(c_Str).style.display == 'none') {
        document.all(c_Str).style.display = 'block';
      } else {
        document.all(c_Str).style.display = 'none';
      }
    }

    //双人模式
    function duteMode() {
      if (room_state) {
        alert("请先退出房间");
        return;
      }
      if (document.all("subscribe").style.display == 'block') {
        duet = true;
        document.all("subscribe").style.display = 'none';
      }
      //双人通话,展示发布框的右侧信息
      alwaysShow("duet_subscribe");
      let publishWindow = document.getElementById("publish_window");
      publishWindow.innerText = "【发布订阅窗口】";
      publishWindow.style.width = '130px';
      alwaysShow("a0");
      alwaysShow("a1");
      alwaysShow("a2");
    }

    //多人模式
    function multiplayerMode() {
      if (room_state) {
        alert("请先退出房间");
        return;
      }
      if (document.all("subscribe").style.display == 'none') {
        duet = false;
        document.all("subscribe").style.display = 'block';
        document.all("subscribe").style.border = "none";
      }
      //多人通话,隐藏发布框的右侧信息
      alwaysNone("duet_subscribe");
      let publishWindow = document.getElementById("publish_window");
      publishWindow.innerText = "【发布窗口】";
      publishWindow.style.width = '110px';
      alwaysShow("a0");
      alwaysShow("a1");
      alwaysShow("a2");
    }

    //设置元素展示
    window.alwaysShow = function (c_Str) {
      document.all(c_Str).style.display = 'block';
    }

    window.alwaysShowInline = function (c_Str) {
      document.all(c_Str).style.display = 'inline';
    }

    //设置元素隐藏
    window.alwaysNone = function (c_Str) {
      document.all(c_Str).style.display = 'none';
    }

    //调整publish_device2的值
    function publishDeviceChange1() {
      let publishDevice = $("#publish_device").val();
      let file = document.getElementById("v_file");
      switch (publishDevice) {
        case "1":
          $("#publish_device2").val("1");
          file.style.display = 'none';
          break;
        case "2":
          $("#publish_device2").val("2");
          file.style.display = 'none';
          break;
        case "3":
          $("#publish_device2").val("3");
          file.style.display = 'inline';
          break;
        case "4":
          $("#publish_device2").val("4");
          file.style.display = 'none';
          break;
      }
    }

    //调整publish_device的值
    function publishDeviceChange2() {
      let publishDevice = $("#publish_device2").val();
      let file = document.getElementById("v_file");
      switch (publishDevice) {
        case "1":
          $("#publish_device").val("1");
          file.style.display = 'none';
          break;
        case "2":
          $("#publish_device").val("2");
          file.style.display = 'none';
          break;
        case "3":
          $("#publish_device").val("3");
          file.style.display = 'inline';
          break;
        case "4":
          $("#publish_device").val("4");
          file.style.display = 'none';
          break;
      }
    }
  </script>
  <!--初始化信息-->
  <script type="module">
    // let httpsFixButton = document.getElementById("httpsFixButton");
    let mute_Audio = document.getElementById("mute-audio");
    let mute_Video = document.getElementById("mute-video");
    const localVideo = document.getElementById('publish_video1');
    let publish_device = parseInt($("#publish_device").val());
    let isSafariNavigator = (/Safari|iPhone/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent));

    //默认双人模式
    let duet = true;
    let client_cost_time = 0;
    let stream_duration_timer = -1;
    let mediaInfo;
    let hideIconsAfterTimeout;
    let role = "";
    //绑定切换视频大小
    $('#publish_video1').click(function (e) {
      let classes = $('.publishVideo').attr('class');
      if (classes.indexOf('side') > -1) {
        $('.subscribeVideo').addClass('side');
        $('.publishVideo').removeClass('side');
      };
    });
    $('#video0').click(function (e) {
      let classes = $('.subscribeVideo').attr('class');
      if (classes.indexOf('side') > -1) {
        $('.publishVideo').addClass('side');
        $('.subscribeVideo').removeClass('side');
      };
    });
    //生成uid
    function addPreZero(num) {
      var t = (num + '').length,
        s = '';

      for (var i = 0; i < 4 - t; i++) {
        s += '0';
      }

      return s + num;
    }
    let randomNum = Math.floor(Math.random() * 10000);
    $('#uid').val(addPreZero(randomNum))
    // 实例化SDK
    let test_controller = new McuController();
    let conn_state = 0;
    let room_state = 0;
    let vod_state = 0;

    if (!publish_device) {
      publish_device = 1;
    }

    // ###### 建立连接/断开连接 ######
    // 建立连接
    $("#connectButton").click(function () {

      //已连接,直接返回
      if (conn_state == 1) {
        return;
      }
      let biz_name = $("#biz_name").val();
      let appId = $("#appId").val();
      let uid = $("#uid").val();
      let workspaceId = $("#workspaceId").val();
      let select_room = $("#select_room").val();

      let config_param = {};
      config_param.uid = uid;
      config_param.biz_name = biz_name;
      config_param.appId = appId;
      config_param.workspaceId = workspaceId;
      config_param.room_server_url = select_room;
      config_param.sign = getSign(uid);

      // 允许最大断网时间 (超过未重连, 直接关闭)
      config_param.network_check_timeout = 10000;
      test_controller.Connect(config_param);
    });

    // 断开连接
    $("#disconnectButton").click(function () {

      if (conn_state == 0) {
        return;
      }
      test_controller.Disconnect();
    });


    //建立连接失败回调
    test_controller.OnConnectFailed = function (code, msg) {
      conn_state = 0;
      alert("建立连接失败, 请尝试https修复");
      document.getElementById("conn_state").innerText = "初始化失败: " + msg;
    };

    //建立连接成功回调
    test_controller.OnConnectOK = function () {
      conn_state = 1;
      document.getElementById("conn_state").innerText = "已连接";

    };

    //断开连接回调
    test_controller.OnConnectClose = function (code, msg) {
      conn_state = 0;
      document.getElementById("conn_state").innerText = "断开";
    };

    function setMediaInfo(config_param) {
      let aspectRatioStrongDepend = document.getElementById("aspect_ratio_strong_depend").checked;
      let aspectRatio = document.getElementById("aspectRatio").value;
      let audioSource = audioInputSelect.value;
      let videoSource = videoSelect.value;
      config_param.audioSource = audioSource;
      config_param.videoSource = videoSource;
      config_param.aspectRatioStrongDepend = aspectRatioStrongDepend;
      config_param.aspectRatio = aspectRatio;
      // config_param.local_video_width = 720;
      // config_param.local_video_height = 300;
    }

    // ###### 房间相关 #######
    // 初始化房间
    function initRoomInfo() {

      let config_param = {};
      publish_device = parseInt($("#publish_device").val());
      // 发布弱网码率告警
      test_controller.SetPublishWeakBitrateLimit(parseInt($("#weak_bitrate").val()));
      //订阅发布弱网码率告警
      test_controller.SetSubscribeWeakBitrateLimit(parseInt($("#remote_weak_bitrate").val()));
      // 编码方式
      test_controller.SetLocalCodecType($("#select_codec").val());
      // 协议类型
      test_controller.SetLocalProtoType($("#proto_type").val());

      //设置初始化参数
      config_param.auto_publish_subscribe = 3;
      let video_profile_type = $("#video_profile_type").val();
      if (video_profile_type == "99") {
        config_param.local_video_width = 640;
        config_param.local_video_height = 480;
        config_param.local_video_frame = 3;
        config_param.local_video_bitrate = 600;
      } else {
        config_param.video_profile_type = video_profile_type;
      }

      let initPublish = [{
        publish_video_id: "publish_video1",
        publish_streamId_id: "publish_streamId1",
        publish_tag: "VIDEO_SOURCE_CAMERA_1"
      }];

      //分业务模式传入订阅参数
      let initSubscribe;
      if (duet) {
        initSubscribe = [{
          subscribe_video_id: "video0",
          subscribe_audio_id: "audio0",
          subscribe_streamId_id: "subscribe_streamId0",
          feedId_id: "feedId0"
        }, {
          subscribe_video_id: "video4",
          subscribe_audio_id: "audio4"
        }];
      } else {
        initSubscribe = [{
          subscribe_video_id: "video1",
          subscribe_audio_id: "audio1",
          subscribe_streamId_id: "subscribe_streamId1",
          feedId_id: "feedId1"
        }, {
          subscribe_video_id: "video2",
          subscribe_audio_id: "audio2",
          subscribe_streamId_id: "subscribe_streamId2",
          feedId_id: "feedId2"
        }];
      }
      let mediaType = $("#media_type").val();
      config_param.publish_device = publish_device;
      switch (config_param.auto_publish_subscribe) {
        case 1:
          //订阅的时候的参数
          config_param.initSubscribe = initSubscribe;
          break;
        case 2:
          //发布的时候的参数
          config_param.initPublish = initPublish;
          config_param.media_type = parseInt(mediaType);
          setMediaInfo(config_param);
          break;
        case 3:
          config_param.media_type = mediaType;
          config_param.initPublish = initPublish;
          config_param.initSubscribe = initSubscribe;
          setMediaInfo(config_param);
          break;
        case 4:
          break;
        default:
          break;
      }

      // 设置录制参数

      //是否需要实时音量值,默认为false
      config_param.need_volume_analyser = false;
      let transport_ = document.getElementById("transport_").value;
      config_param.transport_ = transport_;
      let default_turn_server = document.getElementById("default_turn_server").value;
      config_param.defaultTurnServer = default_turn_server;
      // 预热摄像头+麦克风
      // if (config_param.publish_device == 1) {
      //     test_controller.PreOpenLocalMedia(config_param);
      // }
      test_controller.InitRoomConfig(config_param);
    }

    // 初始化成功回调
    test_controller.OnInitRoomConfigOK = function () {
      if (role == "caller") {
        test_controller.CreateRoom(getSign($("#uid").val()));
      } else if (role == "callee") {
        let room_id = $("#room_id").val().trim();
        let rtoken = $("#rtoken").val();
        test_controller.JoinRoom(room_id, rtoken, getSign($("#uid").val()));
      }
    };

    // 创建房间
    $("#createButton").click(function () {
      if (conn_state == 0) {
        alert("请先建立连接");
        return;
      }
      role = "caller";
      if (room_state != 0) {
        return;
      }
      this.room_state = "create_room";
      initRoomInfo();
    });

    // 创建房间成功回调
    test_controller.OnCreateRoomSucc = function (room_id, rtoken) {
      document.getElementById("room_id").value = room_id;
      document.getElementById("room_id_m").innerText = room_id;
      document.getElementById("rtoken").value = rtoken;
      document.getElementById("rtoken_m").innerText = rtoken;
      $('#uid_m').text($('#uid').val());
      room_state = 1;
      document.getElementById("join_room_state").innerText = "是";
      $('.info').css('display', 'none');
      $('.header').css('display', 'none');
      $('#videos').css('display', 'block');
      $('.subscribeVideo').css('display', 'none');
      $('.publishVideo').removeClass('connected');
    };


    // 加入房间
    $("#joinButton").click(function () {
      if (conn_state == 0) {
        alert("请先建立连接");
        return;
      }

      if (room_state != 0) {
        return;
      }
      role = "callee";
      if (!$('#room_id').val() || !$('#rtoken').val()) {
        alert('请输入房间号和密码');
        return
      }
      initRoomInfo();
    });

    // 加入房间成功
    test_controller.OnJoinRoomSucc = function () {
      room_state = 1;
      document.getElementById("join_room_state").innerText = "是";
      document.getElementById("room_id_m").innerText = document.getElementById("room_id").value;
      document.getElementById("rtoken_m").innerText = document.getElementById("rtoken").value;
      $('#uid_m').text($('#uid').val());
      $('.info').css('display', 'none');
      $('.header').css('display', 'none');
      $('#videos').css('display', 'block');
      $('.publishVideo').addClass('connected').addClass('side');
      $('.subscribeVideo').css('display', 'block');

    };

    // 邀请加入
    $("#inviteButton").click(function () {
      if (conn_state == 0) {
        alert("请先建立连接");
        return;
      }
      if (room_state == 0) {
        alert("请先创建房间");
        return;
      }
      let invitee = $("#invitee").val();
      let invitationChannelType = parseInt($("#invitation_channel_type").val());
      let invitationLink = 'demo' //$("#invitation_link").val();
      if (!invitee || invitee == "") {
        alert("请填入被邀请者uid");
        return;
      }
      if (isNaN(invitationChannelType)) {
        alert("invitationChannelType is NaN");
        return;
      }
      test_controller.Invite(invitee, invitationChannelType, invitationLink);
    });


    // 邀请成功
    test_controller.OnInviteOK = function () {
      document.getElementById("invite_state").innerText = "邀请成功";

    };

    // 邀请失败
    test_controller.OnInviteFail = function (code, msg) {
      document.getElementById("invite_state").innerText = "邀请失败";
    };


    // 被邀请
    test_controller.OnInviteRequest = function (room_id, rtoken, inviter, extra, inviteId, inviteInfo) {
      let media_inviteInfo = {};
      if (inviteInfo) {
        media_inviteInfo.audioEnable = inviteInfo.audioEnable;
        media_inviteInfo.videoEnable = inviteInfo.videoEnable;
      }

      if (confirm("用户[" + inviter + "]邀请你加入房间[" + room_id + "], 是否接受?")) {
        role = "callee";

        document.getElementById("room_id").value = room_id;
        document.getElementById("rtoken").value = rtoken;
        test_controller.ReplyInvite(room_id, inviter, 0, inviteId, media_inviteInfo, extra);
        initRoomInfo();
      } else {
        test_controller.ReplyInvite(room_id, inviter, 2, inviteId, media_inviteInfo, extra);
      }
    };

    // 退出房间
    $("#endButton").click(function () {
      if (room_state == 0) {
        alert("当前不在房间中");
        return;
      }
      test_controller.LeaveRoom();
    });

    // 退出房间
    $("#hangup").click(function () {
      if (room_state == 0) {
        alert("当前不在房间中");
        return;
      }
      test_controller.LeaveRoom();
    });
    // 退出房间回调
    test_controller.OnLeaveRoom = function (leaveType) {
      test_controller.warning(`~~~~~~~~~~~~~ leave room! leaveType = ${leaveType}`);
      room_state = 0;
      document.getElementById("room_id").value = "";
      document.getElementById("rtoken").value = "";
      document.getElementById("invitee").value = "";

      document.getElementById("invite_state").innerText = "";
      document.getElementById("join_room_state").innerText = "否";
      // document.getElementById("remote_server_record_id").innerText = "";

      // document.getElementById("status").innerText = "";
      // document.getElementById("fileType").innerText = "";
      // document.getElementById("filePath").innerText = "";

      // document.getElementById("streamId_text").style.display = "none";

      if (publish_device == 3) {
        localVideo.src = "";
      }

      // $("#vod_id").text("");

      //清空与会者列表
      // $("#participants_table tbody tr").each(function() {
      //     if ($(this).find("td").eq(0).html()) {
      //         $(this).remove();
      //     }
      // });
      clearInterval(publish_media_stat_timer_id);
      publish_media_stat_timer_id = -1;
      document.getElementById("publish_media_stat1").innerText = "";
      $('#videos').css('display', 'none');
      $('.info').css('display', 'block');
      $('.header').css('display', 'block');
      $('.publishVideo').removeClass('side');
      $('.subscribeVideo').removeClass('side');
      $('.subscribeVideo').css('display', 'none');
    };

    //房间与会者列表信息
    test_controller.OnRoomAttendanceList = function (participants) {
      for (var i = 0; i < participants.length; i++) {
        let part = participants[i];
        let publishs = part.publish;
        if (publishs.length != 0) {
          for (var j = 0; j < publishs.length; j++) {
            let publish = publishs[j];
            let tag = publish.tag;
            if (!tag) {
              tag = "";
            }
            let result = "";
            result += "<tr>";
            result += "<td>" + part.uid + "</td>";
            result += "<td>" + publish.feedId + "</td>";
            result += "<td>" + tag + "</td>";
            result += "<td><button class='css-3d-btn' onclick='subscribeButton(\"" + publish.feedId +
              "\")'>订阅</button></td>";
            result += "</tr>";
            $("#participants_table tbody").append(result);
          }
        }
      }

    };

    //推送“退出房间者”给与会者
    test_controller.OnParticipantLeaveRoom = function (uid, exitType) {
      this.warning(`~~~~~~~~~~~~~ user ${uid} left room! exitType=${exitType}`);
      // $("#participants_table tbody tr").each(function() {
      //     if ($(this).find("td").eq(0).html() == uid) {
      //         $(this).remove();
      //     }
      // });
      $('.publishVideo').removeClass('side');
      $('.subscribeVideo').removeClass('side');
      $('.subscribeVideo').css('display', 'none');
    };

    // ###### 发布订阅相关 ######

    // 签名(通道建连需要)
    //主动传sign给SDK需要的地方。
    function getSign(uid) {
      test_controller.trace(`GetSign uid=${uid}`);
      if ($("#biz_name").val() == "demo") {
        return 'signature';
      } else {
        let new_sign;
        if (uid.indexOf('record_') == 0) {
          new_sign = $("#new_record_sign").val();
        } else {
          new_sign = $("#new_sign").val();
        }
        if (!new_sign) {
          alert("请重写签名");
        }
        console.log(`new sign =${new_sign}`);
        return new_sign;
      }
    }

    var publish_media_stat_timer_id = -1;

    // 发布流
    function publish() {

      let config_param = {};
      let media_type = parseInt($("#media_type").val());

      config_param.need_volume_analyser = false;
      config_param.publish_video_id = "publish_video1";
      config_param.publish_streamId_id = "publish_streamId1";

      let video_profile_type = $("#video_profile_type").val();
      publish_device = parseInt($("#publish_device").val());
      if (publish_device == 2) {
        if (video_profile_type == "99") {
          config_param.local_video_width = 640;
          config_param.local_video_height = 480;
          config_param.local_video_frame = 3;
          config_param.local_video_bitrate = 600;
        } else {
          config_param.video_profile_type = video_profile_type;
        }
        config_param.need_volume_analyser = false;
      } else if (publish_device == 3) {
        //发布文件
        config_param.need_volume_analyser = false;
        let file = document.getElementById('v_file').files[0];
        if (!file) {
          alert("未选择文件");
          return;
        }
        config_param.file = file;
      } else if (publish_device == 4) {
        config_param.need_volume_analyser = false;
        //传入需要共享区域的id
        config_param.part_of_screen_id = "a2";
        let partOfScreenId = config_param.part_of_screen_id;
        let elementById = document.getElementById(partOfScreenId);
        if (!partOfScreenId || !elementById) {
          alert("未选定共享区域");
          return;
        }
      } else {
        setMediaInfo(config_param);
        if (video_profile_type == "99") {
          config_param.local_video_width = 640;
          config_param.local_video_height = 480;
          config_param.local_video_frame = 3;
          config_param.local_video_bitrate = 600;
        } else {
          config_param.video_profile_type = video_profile_type;
        }
      }
      config_param.publish_tag = "VIDEO_SOURCE_CAMERA_1";
      config_param.media_type = media_type;
      config_param.publish_device = publish_device;

      let audioSource = audioInputSelect.value;
      let videoSource = videoSelect.value;
      config_param.audioSource = audioSource;
      config_param.videoSource = videoSource;
      //业务自己处理sid
      let sid = test_controller.Publish(config_param);
    }

    // 发布流
    function publishMedia() {
      if (conn_state == 0) {
        alert("请先建立连接");
        return;
      }

      if (room_state == 0) {
        alert("当前不在房间中");
        return;
      }
      publish();
    }


    //发布成功回调
    test_controller.OnPublishSucc = function (sid) {
      test_controller.trace(`stream publish success,sid=${sid}`);
      let publishDevice = $("#publish_device").val();
      if (publishDevice == "1") {
        alwaysShowInline("mute-audio");
      } else {
        alwaysNone("mute-audio");
      }
      closeClass(mute_Audio);
      closeClass(mute_Video);

      setTimeout(function () {
        document.getElementById("publish_video1").play()
        document.getElementById("video0").muted = false
      }, 2000)
      // document.getElementById("streamId_text").style.display = "inline";

      //隐藏窗口

      // let icons = document.getElementById("icons");
      // icons.classList.remove("hidden");

      // icons.onmouseenter = function() {
      //     window.clearTimeout(hideIconsAfterTimeout);
      // }.bind(this);

      // function clearActive() {
      //     hideIconsAfterTimeout = window.setTimeout(function() {
      //         if (icons.classList.contains('active')) {
      //             icons.classList.remove("active");
      //         }
      //     }.bind(this), 5000);
      // }

      // icons.onmouseleave = function() {
      //     clearActive.call(this);
      // }.bind(this);

      // window.onmousemove = function() {
      //     if (!icons.classList.contains('active')) {
      //         icons.classList.add("active");

      //         if (hideIconsAfterTimeout) {
      //             window.clearTimeout(hideIconsAfterTimeout);
      //         }
      //         clearActive.call(this);
      //     }
      // }

      // publish_media_stat_timer_id = setInterval(function () {
      //     let sid = document.getElementById('publish_video1').name || document.getElementById('publish_streamId1').name;
      //     let publish_media_info = test_controller.GetMediaInfo(sid);
      //     if (publish_media_info) {
      //         let media_stat_arr = publish_media_info.quality_data_;
      //         if (media_stat_arr && media_stat_arr.length > 0) {
      //             let media_stat = media_stat_arr[media_stat_arr.length - 1];
      //             let googAvailableSendBandwidth = (media_stat["VideoBwe"]["googAvailableSendBandwidth"] / 1024).toFixed(2);
      //             let googTransmitBitrate = (media_stat["VideoBwe"]["googTransmitBitrate"] / 1024).toFixed(2);
      //             let ssrcVideoSendLostRate = media_stat["ssrcVideoSend"]["lostRate"];
      //             let ssrcAudioSendLostRate = media_stat["ssrcAudioSend"]["lostRate"];
      //             let weak_googAvailableSendBandwidth = parseInt($("#weak_bitrate").val());
      //             let weak_ssrcVideoSendLostRate = parseInt($("#weak_video_lost_rate").val());
      //             let weak_ssrcAudioSendLostRate= parseInt($("#weak_audio_lost_rate").val());
      //             let weak_str = "网络正常";
      //             if (googAvailableSendBandwidth < weak_googAvailableSendBandwidth) {
      //                 weak_str = "当前网络不佳";
      //             } else if (ssrcVideoSendLostRate > weak_ssrcVideoSendLostRate) {
      //                 weak_str = "当前网络不佳";
      //             } else if (weak_ssrcVideoSendLostRate > weak_ssrcAudioSendLostRate) {
      //                 weak_str = "当前网络不佳";
      //             }
      //             let str = "带宽评估:" + googAvailableSendBandwidth + "kbps; "
      //                         + "实时码率:" + googTransmitBitrate + "kbps; "
      //                         + "视频丢包率:" + ssrcVideoSendLostRate + "%; "
      //                         + "音频丢包率:" + ssrcAudioSendLostRate + "%; "
      //                         + weak_str;
      //             document.getElementById("publish_media_stat1").innerText = str;
      //         }
      //     }
      // }.bind(this), 1000);
    };


    //订阅成功回调
    test_controller.OnSubscribeSucc = function (feedId, sid) {
      test_controller.trace(`~~~~~~~~~~~~~ OnSubscribeSuccess  Response  , sid=${sid},feedId=${feedId}`);
      document.getElementById("audio0").play()
      document.getElementById("video0").play()
    };

    //有新发布推送,对表格做更新操作
    test_controller.OnNewPublish = function (feed) {
      // let tag = feed.tag;
      // if (!tag) {
      //     tag = "";
      // }
      // let trTemp = $("<tr></tr>");
      // trTemp.append("<td >" + feed.uid + "</td>");
      // trTemp.append("<td >" + feed.feedId + "</td>");
      // trTemp.append("<td >" + tag + "</td>");
      // trTemp.append("<td><button class='css-3d-btn' onclick='subscribeButton(\"" + feed.feedId +
      //     "\")'>订阅</button></td>");
      // trTemp.appendTo("#participants_table tbody");
      $('.publishVideo').addClass('connected').addClass('side');
      $('.subscribeVideo').css('display', 'block');
    };

    //订阅流
    function subscribeButton(feedId) {
      if (conn_state == 0) {
        alert("请先建立连接");
        return;
      }
      if (room_state == 0) {
        alert("当前不在房间中");
        return;
      }

      //设置订阅需要的参数
      function setSubscribeParams() {
        let config_param = {};
        let index = 1;
        for (var i = 1; i <= 2; i++) {
          let sid = document.getElementById("video" + i).name;
          if (!sid) {
            index = i;
            break;
          }
        }
        //分业务模式传入订阅参数
        if (duet) {
          //订阅的时候的参数
          config_param.subscribe_video_id = "video0";
          config_param.subscribe_audio_id = "audio0";
          config_param.subscribe_streamId_id = "subscribe_streamId0";
          config_param.feedId_id = "feedId0";
          config_param.need_volume_analyser = false;
        } else {
          //订阅的时候的参数
          config_param.subscribe_video_id = "video" + index;
          config_param.subscribe_audio_id = "audio" + index;
          config_param.subscribe_streamId_id = "subscribe_streamId" + index;
          config_param.feedId_id = "feedId" + index;
          config_param.need_volume_analyser = false;
        }
        config_param.feedId = feedId;
        return config_param;
      }

      let config_param = setSubscribeParams();
      //业务自己处理sid
      var sid = test_controller.Subscribe(config_param);
    }


    // 取消发布流
    function unPublish(sid) {
      if (conn_state == 0) {
        alert("请先建立连接");
        return;
      }
      if (room_state == 0) {
        alert("当前不在房间中");
        return;
      }
      if (!sid) {
        alert("未发布");
        return;
      }
      /*  if (!sid) {
          //纯音频的时候sid在publish_streamId标签中
          sid = document.getElementById('publish_streamId1').name;
        }*/
      test_controller.UnPublish(parseInt(sid));
    }

    //取消发布成功回调
    test_controller.OnUnPublishSucc = function (sid) {
      this.trace(`~~~~~~~~~~~~  OnUnPublishSucc  response, sid=${sid}`);
      document.getElementById("streamId_text").style.display = "none";
      // let icons = document.getElementById("icons1");
      // if (icons.classList.contains('active')) {
      //     icons.classList.remove("active");
      // }
      clearInterval(publish_media_stat_timer_id);
      publish_media_stat_timer_id = -1;
      document.getElementById("publish_media_stat1").innerText = "";
    };

    //取消订阅成功回调
    test_controller.OnUnSubscribeSucc = function (sid) {
      this.trace(`~~~~~~~~~~~~  OnUnSubscribeSucc  response, sid=${sid}`);
    };

    // 取消订阅流
    function unSubscribeButton(sid) {
      if (conn_state == 0) {
        alert("请先建立连接");
        return;
      }
      if (room_state == 0) {
        alert("当前不在房间中");
        return;
      }
      if (sid) {
        test_controller.UnSubscribe(parseInt(sid));
      } else {
        return 0;
      }
    }

    //推送取消发布信息
    test_controller.OnUnPublish = function (feed) {
      let feedId = feed.feedId;
      //删除已取消的发布的订阅行
      $("#participants_table tbody tr").each(function () {
        if ($(this).find("td").eq(1).html() == feedId) {
          $(this).remove();
        }
      });
    };
    //接收对端事件
    test_controller.OnParticipantEvent = function (participant_uid, event_code, event_msg) {
      this.trace(`~~~~~~~~~~~~~ participant ${participant_uid} report an event: event_code:${event_code}, event_msg:${event_msg}`)
    }
    // ###### 开关麦克风  开关摄像头 ######
    // 开麦和关麦 1:开;0:关
    mute_Audio.onclick = function () {
      if (checkStatus()) {
        return false;
      }
      let sid = document.getElementById('publish_video1').name || document.getElementById('publish_streamId1').name;
      if (sid) {
        if (mute_Audio.classList.contains('on')) {
          mute_Audio.classList.remove('on');
          test_controller.SetLocalAudioEnable(1, parseInt(sid));
        } else {
          mute_Audio.classList.add('on');
          test_controller.SetLocalAudioEnable(0, parseInt(sid));
        }
      }
    };

    function closeClass(mute_media) {
      if (mute_media.classList.contains('on')) {
        mute_media.classList.remove('on');
      }
    }

    // 开关摄像头,1:开;0:关
    mute_Video.onclick = function () {
      if (checkStatus()) {
        return false;
      }
      let sid = document.getElementById('publish_video1').name || document.getElementById('publish_streamId1').name;
      if (sid) {
        if (mute_Video.classList.contains('on')) {
          mute_Video.classList.remove('on');
          test_controller.SetLocalVideoEnable(1, parseInt(sid));
        } else {
          mute_Video.classList.add('on');
          test_controller.SetLocalVideoEnable(0, parseInt(sid));
        }
      }
    };

    //状态检查
    function checkStatus() {
      if (conn_state == 0) {
        alert("请先建立连接");
        return true;
      }

      if (room_state == 0) {
        alert("当前不在房间中");
        return true;
      }
    }

    // 本地截图

    //远端截图
    function takePictureRemoteBtn(sid, remote_picture_type) {
      if (!sid) {
        alert("当前不在音视频通话中");
        return;
      }
      let data = test_controller.TakePicture(1, undefined, undefined, parseInt(sid), parseInt(remote_picture_type));
      let img_remote = document.getElementById("previewImgRemote");
      img_remote.style.visibility = "visible";
      img_remote.src = data;
    }

    //收到对端文字消息
    test_controller.OnReceiveTextMsg = function (uid, msg) {
      let reg = /http:\/\/.*?(gif|png|jpg|jpeg|bmp)/gi;
      // 判断是否图片
      if (msg.match(reg)) {
        let nodeP = document.createElement('p');
        let nodeA = document.createElement('a');
        let nodeImg = document.createElement('img');
        nodeA.setAttribute("href", msg);
        nodeImg.setAttribute("src", msg);
        nodeP.classList.add('dialogue-service-contain');
        nodeImg.classList.add('dialogue-text', 'dialogue-service-text');
        nodeA.appendChild(nodeImg);
        nodeP.appendChild(nodeA);
        dialogueContain.appendChild(nodeP);
        dialogueContain.scrollTop = dialogueContain.scrollHeight;
      } else {
        let nodeP = document.createElement('p');
        let nodeSpan = document.createElement('span');
        nodeP.classList.add('dialogue-service-contain');
        nodeSpan.classList.add('dialogue-text', 'dialogue-service-text');
        nodeSpan.innerHTML = uid + ":" + msg;
        nodeP.appendChild(nodeSpan);
        dialogueContain.appendChild(nodeP);
        dialogueContain.scrollTop = dialogueContain.scrollHeight;
      }
    };

    // 聊天功能相关


    //切换前后摄像头
    $('#switchCamera').on('touchend', function () {
      let deviceId = $('#videoSource').val();
      let options = $('#videoSource option');
      let label;
      let newDeviceId = deviceId;
      for (let i = 0; i < options.length; i++) {
        if ($(options[i]).val() == deviceId) {
          if (i == options.length - 1) {
            newDeviceId = $(options[0]).val();
          } else {
            newDeviceId = $(options[i + 1]).val();
          }
          $('#videoSource').val(newDeviceId);
          break;
        }
      };
      const stream = document.getElementById('publish_video1').srcObject;
      const tracks = stream.getTracks();
      tracks.forEach(function (track) {
        track.stop();
      });
      document.getElementById('publish_video1').srcObject = null;
      changeStream();
    })



    function submitCustomerText(text) {
      test_controller.SendTextMsg(text);
    }

    // 渐隐
    function fadeOut(obj) {
      let n = 100;
      let time = setInterval(function () {
        if (n > 0) {
          n -= 10;
          obj.style.opacity = '0.' + n;
        } else if (n <= 30) {
          obj.style.opacity = '0';
          clearInterval(time);
        }
      }, 10);
      return true;
    }

    // 渐显
    function fadeIn(obj) {
      let n = 30;
      let time = setInterval(function () {
        if (n < 90) {
          n += 10;
          obj.style.opacity = '0.' + n;
        } else if (n >= 80) {

          obj.style.opacity = '1';
          clearInterval(time);
        }
      }, 100);
      return true;
    }


    //~~~~录制相关~~~~~~~~
    let record_id = 0;

    //获取浏览器录制id
    function getRecordId() {
      return ++record_id;
    }


    //获取sids
    function getSidsInfo() {
      //发布的sid
      let publish_sid = document.getElementById('publish_video1').name || document.getElementById('publish_streamId1').name;
      //订阅的sid
      let subscribe_sid;
      if (duet) {
        subscribe_sid = document.getElementById('video0').name || document.getElementById('audio0').name;
      } else {
        subscribe_sid = document.getElementById('video1').name || document.getElementById('audio1').name;
      }
      return {
        publish_sid,
        subscribe_sid
      };
    }

    let localRecordStatus = false;

    // 开始浏览器录制



    //停止浏览器录制


    //下载浏览器录制音视频


    //开启浏览器录制成功
    test_controller.OnClientStartRecordSuccess = function (clientRecordId) {
      test_controller.trace(`~~~~~~~~~~~~~ OnClientRecordSuccess,clientRecordId=${clientRecordId}`);
      localRecordStatus = true;
      document.getElementById("client_record_id").innerText = clientRecordId;
    };

    //停止浏览器录制成功回调
    test_controller.OnClientStopRecordSuccess = function (url, blob, clientRecordId) {
      this.trace(`OnClientStopRecordSuccess: video url = ${url},blobSize=${blob.size} clientRecordId = ${clientRecordId}`);
      if (blob) {
        localRecordStatus = false;
        let clientRecordPreview = document.getElementById("clientRecordPreview");
        clientRecordPreview.src = URL.createObjectURL(blob);
      } else {
        console.debug("local blob is null");
      }
    };

    test_controller.OnClientStartRecordFailed = function (clientRecordId, code, msg) {
      test_controller.warning(`~~~~~~~~~~~~~ OnClientStartRecordFailed,clientRecordId=${clientRecordId},code=${code},msg=${msg}`);
    };

    test_controller.OnClientStopRecordFailed = function (clientRecordId, code, msg) {
      test_controller.warning(`~~~~~~~~~~~~~ OnClientStopRecordFailed,clientRecordId=${clientRecordId},code=${code},msg=${msg}`);
    };

    test_controller.OnClientDownloadRecordSuccess = function (clientRecordId) {
      test_controller.trace(`~~~~~~~~~~~~~ OnClientDownloadRecordSuccess,clientRecordId=${clientRecordId}`);
    };

    test_controller.OnClientDownloadRecordFailed = function (clientRecordId, code, msg) {
      test_controller.warning(`~~~~~~~~~~~~~ OnClientDownloadRecordFailed,clientRecordId=${clientRecordId},code=${code},msg=${msg}`);
    };

    test_controller.OnClientPauseRecordSuccess = function (clientRecordId) {
      test_controller.trace(`~~~~~~~~~~~~~ OnClientPauseRecordSuccess,clientRecordId=${clientRecordId}`);
    };

    test_controller.OnClientPauseRecordFailed = function (clientRecordId, code, msg) {
      test_controller.warning(`~~~~~~~~~~~~~ OnClientPauseRecordFailed,clientRecordId=${clientRecordId},code=${code},msg=${msg}`);
    };

    test_controller.OnClientResumeRecordSuccess = function (clientRecordId) {
      test_controller.trace(`~~~~~~~~~~~~~ OnClientResumeRecordSuccess,clientRecordId=${clientRecordId}`);
    };

    test_controller.OnClientResumeRecordFailed = function (clientRecordId, code, msg) {
      test_controller.warning(`~~~~~~~~~~~~~ OnClientResumeRecordFailed,clientRecordId=${clientRecordId},code=${code},msg=${msg}`);
    };


    //################服务端录制########################
    //开始服务端录制
    function startRemoteRecordBtn() {
      if (checkStatus()) {
        return false;
      }
      document.getElementById("status").innerText = "";
      document.getElementById("fileType").innerText = "";
      document.getElementById("filePath").innerText = "";

      //录制文件路径
      let filePath = "recordId_" + (new Date()).valueOf();

      let recordParam = {};
      recordParam.width = parseInt($("#record_width").val());
      recordParam.height = parseInt($("#record_height").val());
      recordParam.fps = parseInt($("#record_fps").val());
      recordParam.sampleRate = parseInt($("#record_sampleRate").val());
      recordParam.channels = parseInt($("#record_channels").val());
      recordParam.audioCodeRate = parseInt($("#record_audioCodeRate").val());
      recordParam.splitType = parseInt($("#record_splitType").val());
      recordParam.startTimeout = parseInt($("#record_timeout").val());
      recordParam.recordTotalStream = parseInt($("#record_total_stream").val());
      recordParam.waterMark = parseInt($("#record_waterMark").val());
      recordParam.waterMarkUrl = $("#record_waterMarkUrl").val();
      recordParam.rtWatermark = parseInt($("#record_rtWatermark").val());
      recordParam.layoutMode = parseInt($("#record_layoutMode").val());
      recordParam.multiModeType = parseInt($("#record_multiModeType").val());
      recordParam.tagFilter = $("#tag_filter").val();
      recordParam.tagPosition = $("#tag_position").val();
      recordParam.mixPosition = $("#mix_position").val();
      recordParam.wmMode = parseInt(document.getElementById("wmMode").value);
      recordParam.silentRecord = document.getElementById("silentRecord").checked;
      recordParam.endType = parseInt($("#record_endType").val());

      test_controller.StartRemoteRecord(filePath, recordParam);
    }

    //开始服务端录制成功回调,recordId为服务端录制id
    test_controller.OnStartRemoteRecordSucc = function (recordId) {
      test_controller.trace(`OnStartRemoteRecordSucc recordId=${recordId}`);
      document.getElementById("remote_server_record_id").innerText = recordId;
      document.getElementById("remote_server_record_id").style.color = 'rgba(219, 87, 51, 1)';
    };

    //暂停服务端录制,recordId为服务端录制id
    function pauseRemoteRecordBtn(recordId) {
      if (!recordId) {
        alert("请先点击开始远端录制");
        return;
      }
      test_controller.PauseRemoteRecord(recordId);
    }

    //恢复服务端录制,recordId为服务端录制id
    function resumeRemoteRecordBtn(recordId) {
      if (!recordId) {
        alert("请先点击开始远端录制");
        return;
      }
      test_controller.ResumeRemoteRecord(recordId);
    }

    //停止服务端录制,recordId为服务端录制id
    function stopRemoteRecordBtn(recordId) {
      if (!recordId) {
        alert("请先点击开始远端录制");
        return;
      }
      test_controller.StopRemoteRecord(recordId);
    }

    //获取服务端录制信息
    function queryRemoteRecord(recordId) {

      //若在离开房间后调用,需自行管理room_id和recordId
      let roomId = $("#room_id").val();
      let recordMediaType = parseInt($("#record_media_type").val());
      if (!recordId || !roomId) {
        alert("参数不对");
        return;
      }
      test_controller.GetRecordInfo(recordId, roomId, recordMediaType, getSign(recordId));
    }

    //获取服务端录制信息回调
    test_controller.OnRemoteRecordInfoSucc = function (recordInfo) {
      test_controller.trace(`~~~~~~~~~~~~~ OnRemoteRecordInfoSucc: recordInfo = ${JSON.stringify(recordInfo)}`);
      let status = recordInfo.status;
      let fileType = recordInfo.fileType;
      let filePath = recordInfo.filePath;

      switch (status) {
        case 0:
          status = "录制中";
          break;
        case 1:
          status = "上传中";
          break;
        case 2:
          status = "录制成功";
          break;
        case 3:
          status = "录制失败";
          break;
        default:
          break;
      }

      switch (fileType) {
        case 1:
          fileType = "本地文件";
          break;
        case 2:
          fileType = "OSS";
          break;
        case 3:
          fileType = "AFTS";
          break;
        default:
          break;
      }

      document.getElementById("status").innerText = "status:" + status;
      if (fileType) {
        document.getElementById("fileType").innerText = "fileType:" + fileType;
      }
      if (filePath) {
        document.getElementById("filePath").innerText = "filePath:" + filePath;
      }

    };
    // 视屏全屏
    function requestFullScreen(element) {
      let requestMethod = element.requestFullScreen || //W3C
        element.webkitRequestFullScreen || //Chrome等
        element.mozRequestFullScreen || //FireFox
        element.msRequestFullScreen; //IE11
      if (requestMethod) {
        requestMethod.call(element);
      } else if (typeof window.ActiveXObject !== "undefined") {
        //for Internet Explorer
        let wscript = new ActiveXObject("WScript.Shell");
        if (wscript !== null) {
          wscript.SendKeys("{F11}");
        }
      }
    }

    //退出全屏(暂时不需要这个按钮)
    function exitFull() {
      var exitMethod = document.exitFullscreen || //W3C
        document.mozCancelFullScreen || //Chrome等
        document.webkitExitFullscreen || //FireFox
        document.webkitExitFullscreen; //IE11
      if (exitMethod) {
        exitMethod.call(document);
      } else if (typeof window.ActiveXObject !== "undefined") { //for Internet Explorer
        var wscript = new ActiveXObject("WScript.Shell");
        if (wscript !== null) {
          wscript.SendKeys("{F11}");
        }
      }
    }

    //获取音量实时数据,音量可视化
    test_controller.OnVolumeAnalyser = function (sid, analyser) {
      // let publish_sid = document.getElementById('publish_video1').name;
      // let subscribe_sid0 = document.getElementById('video0').name || document.getElementById('audio0').name;

      // let volumeView;
      // switch (sid) {
      //     case publish_sid:
      //         volumeView = "publish_volumeView";
      //         break;
      //     case subscribe_sid0:
      //         volumeView = "subscribe_volumeView0";
      //         break;
      //     case subscribe_sid1:
      //         volumeView = "subscribe_volumeView1";
      //         break;
      //     case subscribe_sid2:
      //         volumeView = "subscribe_volumeView2";
      //         break;
      // }
      // if (!volumeView) {
      //     return;
      // }
      // let canvas = document.getElementById(volumeView);
      // let ctx = canvas.getContext("2d");

      // let outcanvas = document.createElement("canvas");
      // outcanvas.width = canvas.width;
      // outcanvas.height = canvas.height;
      // ctx.strokeStyle = "#FF4500";
      // ctx.lineWidth = 2;
      // ctx.clearRect(0, 0, canvas.width, canvas.height); //清理画布
      // let dataArray = new Uint8Array(analyser.frequencyBinCount);
      // analyser.getByteFrequencyData(dataArray);
      // let step = Math.round(dataArray.length / 60); //采样步长
      // for (var i = 0; i < 40; i++) {
      //     let energy = (dataArray[step * i] / 256.0) * 50;
      //     for (var j = 0; j < energy; j++) {
      //         ctx.beginPath();
      //         ctx.moveTo(20 * i + 2, 200 + 4 * j);
      //         ctx.lineTo(20 * (i + 1) - 2, 200 + 4 * j);
      //         ctx.stroke();
      //         ctx.beginPath();
      //         ctx.moveTo(20 * i + 2, 200 - 4 * j);
      //         ctx.lineTo(20 * (i + 1) - 2, 200 - 4 * j);
      //         ctx.stroke();
      //     }
      //     ctx.beginPath();
      //     ctx.moveTo(20 * i + 2, 200);
      //     ctx.lineTo(20 * (i + 1) - 2, 200);
      //     ctx.stroke();
      // }

      // //制造半透明投影
      // function draw() {
      //     ctx.drawImage(outcanvas, 0, 0);
      //     ctx.save();
      //     ctx.translate(canvas.width / 2, canvas.height / 2);
      //     ctx.rotate(Math.PI);
      //     ctx.scale(-1, 1);
      //     ctx.drawImage(outcanvas, -canvas.width / 2, -canvas.height / 2);
      //     ctx.restore();
      //     ctx.fillStyle = 'rgba(192,192,192, .8)';
      //     ctx.fillRect(0, 0, canvas.width, canvas.height);
      // }

      // draw();
      // requestAnimationFrame(test_controller.OnVolumeAnalyser.bind(this, sid, analyser));
    };

    // 开启点播
    function startVod(vodFile) {
      let vodParams = {};
      if (checkStatus()) {
        return false;
      }
      if (!vodFile) {
        alert("点播文件不能为空");
        return false;
      }
      if (vod_state == 1) {
        alert("已开启点播");
        return false;
      }
      let vodStartTimeout = parseInt($("#vod_timeout").val());
      vodParams.vodFile = vodFile;
      vodParams.vodStartTimeout = vodStartTimeout;
      test_controller.StartVod(vodParams);
    }

    test_controller.OnStartVodSuccess = function (file, vodId) {
      vod_state = 1;
      document.getElementById("vod_id").innerText = vodId;
      document.getElementById("vod_id").style.color = 'rgba(219, 87, 51, 1)';
    };

    // 停止点播
    function stopVod() {
      let vodId = $("#vod_id").text();
      if (checkStatus()) {
        return false;
      }
      if (!vodId || vod_state == 0) {
        alert("未开启点播");
        return false;
      }
      test_controller.StopVod(vodId);
    }

    //停止点播成功
    test_controller.OnStopVodSuccess = function (vodId) {
      vod_state = 0;
      document.getElementById("vod_id").style.color = '#808080';
    };

    //推送点播结束
    test_controller.OnVodOver = function (vodId) {
      vod_state = 0;
      document.getElementById("vod_id").style.color = '#808080';
    };

    //错误日志上报
    function downloadLog() {
      test_controller.DownloadLog();
    }

    //录制通知
    test_controller.OnStartRemoteRecordFailed = function (recordId, err_code, msg) {
      test_controller.warning(`OnStartRemoteRecordFailed recordId= ${recordId}, code= ${err_code},msg= ${msg}`);
      alert(`err_code=${err_code},msg=${msg}`);
    };

    //录制过程中失败
    test_controller.OnRemoteRecordingFailed = function (recordId, feedId, code, msg) {
      test_controller.warning(`OnRemoteRecordingFailed recordId= ${recordId},feedId= ${feedId}, code= ${code},msg= ${msg}`);
      alert(`err_code=${code},msg=${msg}`);
    };

    //停止录制成功
    test_controller.OnStopRemoteRecordSucc = function (recordId) {
      document.getElementById("remote_server_record_id").style.color = '#808080';
    };

    //切流
    function streamChange() {
      if (checkStatus()) {
        return false;
      }
      publish_device = parseInt($("#publish_device").val());
      // publish_device值说明如下
      //1 stream  摄像头
      //2 stream  共享桌面
      //3 stream  文件流
      //4 stream  共享自定义区域
      let sid = document.getElementById('publish_video1').name;
      let publish_config = {};
      let publishDevice = parseInt($("#publish_device").val());
      publish_config.publish_device = publishDevice;
      publish_config.media_type = parseInt($("#media_type").val());
      publish_config.sid = sid;
      setMediaInfo(publish_config);

      //分辨率切换
      let video_profile_type = $("#video_profile_type").val();
      if (video_profile_type == "99") {
        publish_config.local_video_width = 640;
        publish_config.local_video_height = 480;
        publish_config.local_video_frame = 3;
        publish_config.local_video_bitrate = 600;
      } else {
        publish_config.video_profile_type = video_profile_type;
      }

      //切到文件流
      if (publish_device == 3) {
        let file = document.getElementById('v_file').files[0];
        if (!file) {
          alert("未选择文件");
          return;
        } else {
          publish_config.file = file;
        }
      }

      //切到共享区域
      if (publish_device == 4) {
        publish_config.part_of_screen_id = "a2";
        let partOfScreenId = publish_config.part_of_screen_id;
        let elementById = document.getElementById(partOfScreenId);
        if (!partOfScreenId || !elementById) {
          alert("未选定共享区域");
          return;
        }
      }
      let stream = test_controller.ChangeMediaStream(publish_config);
    }

    //动态切流
    function changeStream() {
      let sid = document.getElementById('publish_video1').name;
      publish_device = parseInt($("#publish_device").val());
      let video_profile_type = $("#video_profile_type").val();

      //先只支持摄像头的切换
      if (sid && publish_device == 1) {
        let config = {};
        config.sid = sid;
        if (video_profile_type == "99") {
          config.local_video_width = 640;
          config.local_video_height = 480;
          config.local_video_frame = 3;
          config.local_video_bitrate = 600;
        } else {
          config.video_profile_type = video_profile_type;
        }
        setMediaInfo(config);
        test_controller.ChangeProfile(config);
      }
    }

    //动态切换分辨率
    $("#video_profile_type").change(function () {
      changeStream();
    })

    //动态切换麦克风
    $("#audioSource").change(function () {
      changeStream();
    })

    //动态切换摄像头
    $("#videoSource").change(function () {
      changeStream();
    })

    //动态切换横纵比
    $("#aspectRatio").change(function () {
      let aspectRatioStrongDepend = document.getElementById("aspect_ratio_strong_depend").checked;
      if (aspectRatioStrongDepend) {
        changeStream();
      }
    })
    //获取设备信息测试
    function getDevices() {
      test_controller.GetDevices();
    }

    //获取设备成功
    test_controller.OnGetDevicesSuccess = function (devicesInfo) {
      test_controller.trace(JSON.stringify(devicesInfo));
    }

    //获取设备失败
    test_controller.OnGetDevicesFailed = function (code, msg) {
      test_controller.warning(`OnGetDevicesFailed code=${code},msg=${msg}`);
    }
  </script>

</body>

</html>
