<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="utf-8">
  <meta name="description" content="MEETING reference app">
  <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1">
  <meta itemprop="description" content="Video chat using the reference MRTC application">
  <meta itemprop="name" content="MEETING">
  <meta name="mobile-web-app-capable" content="yes">
  <meta id="theme-color" name="theme-color" content="#1e1e1e">
  <base target="_blank">
  <title>MCU DEMO</title>
  <style>
    .inputNumber {
      width: 30px;
    }

    #publish_media_stat1 {
      word-wrap: break-word;
      max-width: 640px;
      display: inline-block;
    }

    #subscribe_media_stat1 {
      word-wrap: break-word;
      max-width: 640px;
      display: inline-block;
    }
  </style>
  <link rel="stylesheet" type="text/css" href="./lib/dialogue.css">
</head>

<body>
  <label type="text" style="color: #3A6EA5">&nbsp;请选择业务模式</label> &nbsp;&nbsp;&nbsp;&nbsp;
  <button id="duet" onclick="duetMode()" class="button blue">&nbsp;&nbsp;双人通话&nbsp;&nbsp;</button>
  <button id="multiplayer" onclick="multiplayerMode()" class="button blue">&nbsp;&nbsp;多人通话&nbsp;&nbsp;</button>
  <table border="1" cellspacing="0" cellpadding="0">
    <!--注意事项-->
    <tr>
      <td>
        <button class="button green rarrow" onclick="show('a0')" style="width:180px">
          【注意事项及使用说明】
        </button>
        <div id="a0" style="display: block">
          <div id="videos" border="2px">
            &nbsp; 1、请使用
            <label type="text" class="css-text-color">chrome浏览器，67版本以上</label> , 必须使用
            <label type="text" class="css-text-color">https</label> ;
            <br>&nbsp; 2、使用步骤:
            <label type="text" class="css-text-color">【连接】--&gt;</label>
            <label type="text" class="css-text-color">【创建房间】/【邀请加入】/【加入房间】--&gt;</label>
            <label type="text" class="css-text-color">【发布音视频】/【订阅音视频】--&gt;</label>
            <label type="text" class="css-text-color">【取消发布音视频】/【取消订阅音视频】</label>
            <button id="mobileLog" class="css-3d-btn" onclick="mobileLog()">
              &nbsp;&nbsp;手机端日志展示&nbsp;&nbsp;
            </button>
            <br> &nbsp;
          </div>
        </div>
      </td>
    </tr>

    <!-- 建立连接 -->
    <tr>
      <td>
        <button class="button green rarrow" onclick="show('a1')" style="width:110px">【建立连接】
        </button>
        <div id="a1">
          <div id="callstart">
            &nbsp;
            <label text="biz_name:">bizName:</label>
            <input type="text" id="biz_name" value="demo" style="width:80px;" />&nbsp;

            <label text="sub_biz:">subBiz/appId:</label>
            <input type="text" id="sub_biz" value="default" style="width:80px;" />&nbsp;

            <label text="workspaceId:">workspaceId:</label>
            <input type="text" id="workspaceId" value="default" style="width:70px;" />&nbsp;

            <label text="uid:">uid:</label>
            <input type="text" id="uid" style="width:150px;" />&nbsp;

            <label text="room_server">房间服务器:</label>&nbsp;
            <select name="select" id="select_room" class="xla_k">
              <option value="wss://mrtc.mpaas.cn-hangzhou.aliyuncs.com/ws">&nbsp;非金生产(mpaas)&nbsp;</option>
              <option value="wss://room.mrtc-fin.cn-shanghai.aliyuncs.com/ws">&nbsp;金区生产(mpaas)&nbsp;</option>
            </select> &nbsp;

            <label text="new_sign:">签名:</label>
            <input type="text" id="new_sign" style="width:100px;" value="signature" placeholder="请输入签名" />
            <br> &nbsp;

            <button id="connectButton" class="css-3d-btn">&nbsp;&nbsp;连接&nbsp;&nbsp;</button> &nbsp;
            <button id="disconnectButton" class="css-3d-btn">&nbsp;&nbsp;断开&nbsp;&nbsp;</button> &nbsp;
            <button id="httpsFixButton" class="css-3d-btn">&nbsp;&nbsp;https修复&nbsp;&nbsp;</button> &nbsp;
            <label type="text">&nbsp;连接状态:</label>
            <label id="conn_state" type="text" class="css-text-color">断开</label>
          </div>
        </div>

      </td>
    </tr>

    <tr>
      <td>
        <button class="button green rarrow" onclick="show('a2')" style="width:110px">【房间信息】
        </button>
        <div id="a2">
          &nbsp;
          <!-- 房间 -->
          <label text="room_id:">roomid(房间号):</label>
          <input type="text" id="room_id" placeholder="请输入房间号" style="width:150px;" />&nbsp;
          <label text="rtoken:">rtoken(房间密码):</label>
          <input type="text" id="rtoken" value="123" placeholder="请输入房间密码" style="width:100px;" />&nbsp;
          <label text="third_id:" hidden>业务id:</label>
          <input type="text" id="third_id" value="" style="width:50px;" hidden />&nbsp;
          <label text="engine">engine:</label>
          <select name="engine" id="engine" class="xla_k">
            <option value="0" selected>&nbsp;alipay&nbsp;</option>
            <option value="1">&nbsp;aliyun&nbsp;</option>
            <option value="2">&nbsp;p2p&nbsp;</option>
          </select>&nbsp;

          <label text="publish_device" class="css-text-color">发布内容:</label>
          <select name="publish_device" id="publish_device" class="xla_k css-text-color"
            onchange="publishDeviceChange1()">
            <option selected value="1">&nbsp;1.摄像头&nbsp;</option>
            <option value="2">&nbsp;2.共享桌面&nbsp;</option>
            <option value="3">&nbsp;3.共享文件&nbsp;</option>
            <option value="4">&nbsp;4.共享html区域&nbsp;</option>
            <option value="5">&nbsp;5.自定义推流&nbsp;</option>
          </select>&nbsp;

          <label text="auto_publish_subscribe" class="css-text-color">自动发布订阅:</label>
          <select name="auto_publish_subscribe" id="auto_publish_subscribe" class="xla_k css-text-color">
            <option value="1">&nbsp;1.自动订阅&nbsp;</option>
            <option value="2">&nbsp;2.自动发布&nbsp;</option>
            <option value="3" selected>&nbsp;3.自动发布/订阅&nbsp;</option>
            <option value="4">&nbsp;4.手动发布/订阅&nbsp;</option>
            <option value="5">&nbsp;5.自动发布/订阅(当人数>1)&nbsp;</option>
          </select>&nbsp;

          <label for="defaultRecord"><input id="defaultRecord" type="checkbox">自动录制</label>&nbsp;
          <label for="recordStrongDepend"><input id="recordStrongDepend" type="checkbox" checked>录制强依赖</label>&nbsp;
          <br>
          <br>&nbsp;

          <label text="publish_tag">发布tag:</label>
          <input id="publish_tag" type="text" value="VIDEO_SOURCE_CAMERA" style="width:180px;">&nbsp;

          <label text="media_type">流类型:</label>
          <input type="checkbox" name="enableAudio" id="enableAudio" checked>&nbsp;audio
          <input type="checkbox" name="enableVideo" id="enableVideo" checked>&nbsp;video
          <input type="checkbox" name="enableDataChannel" id="enableDataChannel">&nbsp;datachannel
          &nbsp;

          <label text="codec_type">编码方式:</label>
          <select name="select_codec" id="select_codec" class="xla_k">
            <option value="AUTO" selected>&nbsp;系统自适应&nbsp;</option>
            <option value="H264">&nbsp;H264&nbsp;</option>
            <option value="AV1">&nbsp;AV1&nbsp;</option>
            <option value="VP9">&nbsp;VP9&nbsp;</option>
            <option value="VP8">&nbsp;VP8&nbsp;</option>
          </select>&nbsp;

          <label text="video_profile_type">分辨率:</label>
          <select name="select" id="video_profile_type" class="xla_k">
            <option value="2" selected>&nbsp;VGA, 640x480, 4:3&nbsp;</option>
            <option value="6">&nbsp;1080p, 1920x1080, 16:9&nbsp;</option>
            <option value="1">&nbsp;720p, 1280x720, 16:9&nbsp;</option>
            <option value="9">&nbsp;540P, 960x540, 16:9&nbsp;</option>
            <option value="3">&nbsp;360p, 640x360, 16:9&nbsp;</option>
            <option value="8">&nbsp;90p(竖), 90x160, 9:16&nbsp;</option>
            <option value="5">&nbsp;360p(竖), 360x640, 9:16&nbsp;</option>
            <option value="10">&nbsp;540P(竖), 540x960, 9:16&nbsp;</option>
            <option value="4">&nbsp;720p(竖), 720x1280, 9:16&nbsp;</option>
            <option value="7">&nbsp;1080p(竖), 1080x1920, 9:16&nbsp;</option>
            <option value="99">&nbsp;低帧率测试(fps=3)&nbsp;</option>
            <option value="100">&nbsp;自定义&nbsp;</option>
          </select>&nbsp;
          <span id="video_profile_diy">
            自定义:
            <input id="video_profile_diy_width" type="number" placeholder="宽" value="" style="width:40px;">
            <input id="video_profile_diy_height" type="number" placeholder="高" value="" style="width:40px;">
            <input id="video_profile_diy_framerate" type="number" placeholder="帧率" value="" style="width:40px;">
            <input id="video_profile_diy_bitrate" type="number" placeholder="码率" value="" style="width:40px;">
          </span>
          <br><br>&nbsp;

          <label text="bitrate">发布弱网告警(带宽评估):</label>
          <input type="text" id="weak_bitrate" value="200" style="width:30px;" />&nbsp;

          <label text="bitrate">发布弱网告警(视频丢包率):</label>
          <input type="text" id="weak_video_lost_rate" value="20" style="width:30px;" /> &nbsp;

          <label text="bitrate">发布弱网告警(音频丢包率):</label>
          <input type="text" id="weak_audio_lost_rate" value="20" style="width:30px;" /> &nbsp;

          <label for="degradationType">降级策略:</label>
          <select name="degradationType" id="degradationType" class="xla_k">
            <option selected value=1>&nbsp;流畅度优先&nbsp;</option>
            <option value=2>&nbsp;清晰度优先&nbsp;</option>
          </select>&nbsp;

          <label text="codec_type">传输方式:</label>
          <select name="transport_" id="transport_" class="xla_k">
            <option selected value="all">&nbsp;all&nbsp;</option>
            <option value="relay">&nbsp;relay&nbsp;</option>
          </select>&nbsp;
          <label text="default_turn_server">自定义coturn:</label>
          <input type="text" id="default_turn_server" style="width:200px;" placeholder="请输入中转服务" />&nbsp;
          <br><br>&nbsp;

          <label text="sknm">SRTP密钥交换方式:</label>
          <select name="select" id="sknm" class="xla_k">
            <option value="0,1" selected>&nbsp;ALL(优先DTLS)&nbsp;</option>
            <option value="1,0">&nbsp;ALL(优先SDES)&nbsp;</option>
            <option value="0">&nbsp;DTLS&nbsp;</option>
            <option value="1">&nbsp;SDES&nbsp;</option>
          </select>&nbsp;

          <label for="E2EE_enable">端到端加密(E2EE)</label>
          <input type="checkbox" id="E2EE_enable">
          <label for="E2EE_ikm">E2EE材料:</label>
          <input type="text" id="E2EE_ikm" value="secret0123456789" style="width:120px;" />&nbsp;
          <label for="scalabilityMode">SVC:</label>
          <select id="scalabilityMode">

          </select>
          <label>美颜</label>&nbsp;
          <select id="beauty_strength" class="xla_k">
            <option value=0 selected>关</option>
            <option value=1>弱</option>
            <option value=2>中</option>
            <option value=5>强</option>
          </select>&nbsp;

          <label for="blurSwitch">背景虚化开启</label>
          <input type="checkbox" id="blurSwitch">

          <label for="blurURL">背景虚化图片URL:</label>
          <input type="text" id="blurURL" style="width:200px;">
          <br><br>&nbsp;

          <label for="videoSource">摄像头设备:</label><select id="videoSource"></select>&nbsp;
          <label for="audioSource">麦克风设备:</label><select id="audioSource"></select>&nbsp;
          <label for="audioOutput">音频输出设备:</label><select id="audioOutput"></select>&nbsp;
          <input type="checkbox" id="enableDesktopAudio" />
          <label for="enableDesktopAudio">共享桌面时开启音频(仅支持tab)</label>
          <br>&nbsp;

          <button id="createButton" class="css-3d-btn">&nbsp;&nbsp;创建房间&nbsp;&nbsp;</button>&nbsp;
          <button id="joinButton" class="css-3d-btn">&nbsp;&nbsp;加入房间&nbsp;&nbsp;</button>&nbsp;
          <button id="endButton" class="css-3d-btn">&nbsp;&nbsp;退出房间&nbsp;&nbsp;</button>&nbsp;

          <label type="text">&nbsp;&nbsp;是否在房间中:</label>
          <label id="join_room_state" type="text" class="css-text-color">否</label>
          <br>&nbsp;

          <input type="text" id="invitee" class="mcu-placeholder" placeholder="请填入被邀请者uid (需在线)" style="width:200px;" />
          &nbsp;
          <label class="css-text-color">推送渠道:</label>
          <select name="channel_type" id="invitation_channel_type" class="xla_k css-text-color">
            <option value="0" selected>&nbsp;WEB&nbsp;</option>
            <option value="1">&nbsp;ALIPAY&nbsp;</option>
          </select>&nbsp;
          <input type="text" id="invitation_link" class="mcu-placeholder" placeholder="请填入邀请参数 (WEB不需要)"
            style="width:200px;" /> &nbsp;
          <button id="inviteButton" class="css-3d-btn">&nbsp;&nbsp;邀请加入房间&nbsp;&nbsp;</button> &nbsp;&nbsp;
          <label id="invite_state" type="text" style="color:rgba(219, 87, 51, 1)"></label>
        </div>
      </td>
    </tr>

    <!-- 聊天框 -->
    <tr>
      <td>
        <div class="dialogue-wrapper">
          <div id="btn_open" class="dialogue-support-btn">
            <i class="dialogue-support-icon"></i>
            <span class="dialogue-support-text">&nbsp;实时聊天</span>
          </div>
          <!-- 聊天窗口 -->
          <div class="dialogue-main">
            <!-- 聊天窗口头部 -->
            <div class="dialogue-header">
              <button id="btn_close" type="button" class="close" data-dismiss="modal" style="float: right">
                <span aria-hidden="true">&times;</span><span class="sr-only">关闭</span>
              </button>
            </div>
            <div id="dialogue_contain" class="dialogue-contain"></div>
            <div class="dialogue-submit">
              <p id="dialogue_hint" class="dialogue-hint"><span class="dialogue-hint-icon">!</span><span
                  class="dialogue-hint-text">发送内容不能为空</span></p>
              <textarea id="dialogue_input" class="dialogue-input-text"
                placeholder=" 按Enter键提交(shift+Enter换行)"></textarea>
            </div>
          </div>
        </div>
      </td>
    </tr>

    <!-- 发布窗口 -->
    <tr>
      <td>
        <button id="publish_window" class="button green rarrow" onclick="show('a3')" style="width:132px">
          【发布订阅窗口】
        </button>
        <div id="a3" style="display:none">
          <div>
            <table border="1px">
              <tr>
                <td>
                  <table>
                    <tr>
                      <td>
                        <canvas id="publish_volumeView" width="100" height="100"></canvas>

                        <div id="icons" class="hidden">
                          <svg id="mute-audio" width="48" height="48" viewbox="-10 -10 68 68">
                            <title>title</title>
                            <circle cx="24" cy="24" r="34">
                              <title>Mute audio</title>
                            </circle>

                            <path class="on" transform="scale(0.6), translate(17,18)"
                              d="M38 22h-3.4c0 1.49-.31 2.87-.87 4.1l2.46 2.46C37.33 26.61 38 24.38 38 22zm-8.03.33c0-.11.03-.22.03-.33V10c0-3.32-2.69-6-6-6s-6 2.68-6 6v.37l11.97 11.96zM8.55 6L6 8.55l12.02 12.02v1.44c0 3.31 2.67 6 5.98 6 .45 0 .88-.06 1.3-.15l3.32 3.32c-1.43.66-3 1.03-4.62 1.03-5.52 0-10.6-4.2-10.6-10.2H10c0 6.83 5.44 12.47 12 13.44V42h4v-6.56c1.81-.27 3.53-.9 5.08-1.81L39.45 42 42 39.46 8.55 6z"
                              fill="white" />
                            <path class="off" transform="scale(0.6), translate(17,18)"
                              d="M24 28c3.31 0 5.98-2.69 5.98-6L30 10c0-3.32-2.68-6-6-6-3.31 0-6 2.68-6 6v12c0 3.31 2.69 6 6 6zm10.6-6c0 6-5.07 10.2-10.6 10.2-5.52 0-10.6-4.2-10.6-10.2H10c0 6.83 5.44 12.47 12 13.44V42h4v-6.56c6.56-.97 12-6.61 12-13.44h-3.4z"
                              fill="white" />
                          </svg>
                          <svg id="mute-video" width="48" height="48" viewbox="-10 -10 68 68">
                            <circle cx="24" cy="24" r="34">
                              <title>Mute video</title>
                            </circle>

                            <path class="on" transform="scale(0.6), translate(17,16)"
                              d="M40 8H15.64l8 8H28v4.36l1.13 1.13L36 16v12.36l7.97 7.97L44 36V12c0-2.21-1.79-4-4-4zM4.55 2L2 4.55l4.01 4.01C4.81 9.24 4 10.52 4 12v24c0 2.21 1.79 4 4 4h29.45l4 4L44 41.46 4.55 2zM12 16h1.45L28 30.55V32H12V16z"
                              fill="white" />
                            <path class="off" transform="scale(0.6), translate(17,16)"
                              d="M40 8H8c-2.21 0-4 1.79-4 4v24c0 2.21 1.79 4 4 4h32c2.21 0 4-1.79 4-4V12c0-2.21-1.79-4-4-4zm-4 24l-8-6.4V32H12V16h16v6.4l8-6.4v16z"
                              fill="white" />
                          </svg>
                        </div>
                      </td>
                      <!-- 发布窗口-->
                      <td>
                        <div>
                          <video id="publish_video1" autoplay muted="true" width="640" height="480"
                            webkit-playsinline="true" playsinline="true"></video>
                        </div><br>
                        <label id="publish_media_stat1" class="css-text-color" type="text"></label><br>
                        <label type="text" id="streamId_text" hidden>streamId:</label>
                        <label id="publish_streamId1" class="css-text-color" type="text"></label>
                      </td>
                    </tr>
                    <tr>
                      <td colspan="2">
                        <div>
                          <table>
                            <tr>
                              <td>
                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                <label text="publish_device" class="css-text-color">发布类型:</label>
                                <select name="publish_device" id="publish_device1" class="xla_k css-text-color"
                                  onchange="publishDeviceChange2()">
                                  <option selected value="1">
                                    &nbsp;&nbsp;1.摄像头&nbsp;&nbsp;
                                  </option>
                                  <option value="2">&nbsp;&nbsp;2.共享桌面&nbsp;&nbsp;
                                  </option>
                                  <option value="3">&nbsp;&nbsp;3.共享文件&nbsp;&nbsp;
                                  </option>
                                  <option value="4">
                                    &nbsp;&nbsp;4.共享html区域&nbsp;&nbsp;
                                  </option>
                                  <option value="5">
                                    &nbsp;&nbsp;5.自定义推流&nbsp;&nbsp;
                                  </option>
                                </select> &nbsp;&nbsp;
                                <!--  输入框  -->
                                <input id="v_file1" type="file" hidden />
                                <div id="canvas_video_box" style="display: none">
                                  <br>
                                  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                  <input type="checkbox" id="draw_file_video_2_canvas" checked />
                                  <label for="draw_file_video_2_canvas">使用canvas发布video</label>
                                </div>
                                <br>
                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                <button id="publishMediaButton" class="css-3d-btn"
                                  onclick="publishMedia(1)">&nbsp;&nbsp;发布&nbsp;&nbsp;
                                </button> &nbsp;
                                <button id="streamChange" class="css-3d-btn"
                                  onclick="streamChange(1)">&nbsp;&nbsp;切流&nbsp;&nbsp;
                                </button> &nbsp;
                                <button id="unPublish" class="css-3d-btn"
                                  onclick="unPublish(document.getElementById('publish_video1').name || document.getElementById('publish_streamId1').name)">
                                  &nbsp;&nbsp;取消&nbsp;&nbsp;
                                </button> &nbsp;
                                <button id="pauseVideo" class="css-3d-btn" hidden
                                  onclick="pauseVideo(document.getElementById('publish_video1').name || document.getElementById('publish_streamId1').name)">
                                  &nbsp;&nbsp;暂停&nbsp;&nbsp;
                                </button> &nbsp;
                                <button id="playVideo" class="css-3d-btn" hidden
                                  onclick="playVideo(document.getElementById('publish_video1').name || document.getElementById('publish_streamId1').name)">
                                  &nbsp;&nbsp;播放&nbsp;&nbsp;
                                </button> &nbsp;&nbsp;
                                <label text="picture_type">截屏图片类型:</label>
                                <select name="select" id="local_picture_type" class="xla_k">
                                  <option value="1">&nbsp;&nbsp;png&nbsp;&nbsp;
                                  </option>
                                  <option value="2">&nbsp;&nbsp;jpeg&nbsp;&nbsp;
                                  </option>
                                </select>
                                <button id="takePictureBtn" class="css-3d-btn">&nbsp;&nbsp;截屏&nbsp;&nbsp;
                                </button>
                                <br>
                              </td>
                            </tr>
                          </table>
                        </div>
                      </td>
                    </tr>
                  </table>
                </td>

                <!--双人音视频订阅窗口-->
                <td id="duet_subscribe">
                  <table>
                    <tr>
                      <td>
                        <canvas id="subscribe_volumeView0" width="100" height="100"></canvas>
                      </td>
                      <td>
                        <video id="video0" autoplay muted="true" width="640" height="480" webkit-playsinline="true"
                          playsinline="true">
                          video
                        </video>
                        <audio id="audio0" autoplay>音频</audio></br>
                        <label id="subscribe_media_stat1" class="css-text-color" type="text"></label>
                        <br>
                        <video id="video99" autoplay muted="true" width="640" height="480" webkit-playsinline="true"
                          playsinline="true" hidden>
                          video
                        </video>
                        <audio id="audio99" autoplay hidden>音频</audio>
                        <label type="text" id="subscribe_feedId_text0" hidden>&nbsp;&nbsp;feedId:</label>
                        <label id="feedId0" class="css-text-color" type="text"></label>
                        <br>
                        <label type="text" id="subscribe_streamId_text0" hidden>&nbsp;&nbsp;streamId:</label>
                        <label id="subscribe_streamId0" class="css-text-color" type="text"></label>
                      </td>
                    </tr>
                    <tr>
                      <td colspan="2">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        <button class="css-3d-btn"
                          onclick="unSubscribeButton(document.getElementById('video0').name || document.getElementById('audio0').name)">
                          &nbsp;&nbsp;取消&nbsp;&nbsp;
                        </button> &nbsp;&nbsp;
                        <button id="video_fullscreen0" class="css-3d-btn img-fullscreen"
                          onclick="requestFullScreen(document.getElementById('video0'))">
                          &nbsp;&nbsp;全屏&nbsp;&nbsp;
                        </button> &nbsp;&nbsp;
                        <label text="picture_type">截屏图片类型:</label>
                        <select name="select" id="remote_picture_type0" class="xla_k">
                          <option value="1">&nbsp;&nbsp;png&nbsp;&nbsp;</option>
                          <option value="2">&nbsp;&nbsp;jpeg&nbsp;&nbsp;</option>
                        </select>
                        <button id="takePictureRemoteBtn0" class="css-3d-btn"
                          onclick="takePictureRemoteBtn(document.getElementById('video0').name, document.getElementById('remote_picture_type0').value)">
                          &nbsp;&nbsp;截屏&nbsp;&nbsp;
                        </button>
                        <br>
                      </td>
                    </tr>
                  </table>
                </td>

              </tr>
            </table>
          </div>
        </div>
        <br>
      </td>
    </tr>
    <!-- 新增发布流 -->
    <tr>
      <td>
        <button id="new_publish_window" class="button green rarrow" onclick="show('a9')" style="width:132px">
          【新增发布流】
        </button>
        <div id="a9" style="display:none">
          <div>
            <table>
              <tr>
                <td>
                  <div style="transform:rotateY(180deg);">
                    <video id="publish_video5" autoplay muted="true" width="640" height="480" webkit-playsinline="true"
                      playsinline="true"></video><br>
                  </div>
                  <label type="text" id="streamId_text5" hidden>streamId:</label>
                  <label id="publish_streamId5" class="css-text-color" type="text"></label>
                </td>
              </tr>
              <tr>
                <td colspan="2">
                  <div>
                    <table>
                      <tr>
                        <td>
                          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                          <label text="publish_device" class="css-text-color">发布类型:</label>
                          <select name="publish_device" id="publish_device5" class="xla_k css-text-color"
                            onchange="publishDeviceChange3()">
                            <option selected value="1">
                              &nbsp;&nbsp;1.摄像头&nbsp;&nbsp;
                            </option>
                            <option value="2">&nbsp;&nbsp;2.共享桌面&nbsp;&nbsp;
                            </option>
                            <option value="3">&nbsp;&nbsp;3.共享文件&nbsp;&nbsp;
                            </option>
                            <option value="4">
                              &nbsp;&nbsp;4.共享html区域&nbsp;&nbsp;
                            </option>
                            <option value="5">
                              &nbsp;&nbsp;5.自定义推流&nbsp;&nbsp;
                            </option>
                          </select> &nbsp;&nbsp;
                          <!--  输入框  -->
                          <input id="v_file5" type="file" hidden />
                          <br>
                          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                          <button id="publishMediaButton5" class="css-3d-btn"
                            onclick="publishMedia(5)">&nbsp;&nbsp;发布&nbsp;&nbsp;
                          </button> &nbsp;
                          <button id="streamChange5" class="css-3d-btn"
                            onclick="streamChange(5)">&nbsp;&nbsp;切流&nbsp;&nbsp;
                          </button> &nbsp;
                          <button id="unPublish5" class="css-3d-btn"
                            onclick="unPublish(document.getElementById('publish_video5').name)">
                            &nbsp;&nbsp;取消&nbsp;&nbsp;
                          </button> &nbsp;
                          <br>
                          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                          <label text="picture_type">截屏图片类型:</label>
                          <select name="select" id="local_picture_type" class="xla_k">
                            <option value="1">&nbsp;&nbsp;png&nbsp;&nbsp;
                            </option>
                            <option value="2">&nbsp;&nbsp;jpeg&nbsp;&nbsp;
                            </option>
                          </select>
                          <button id="takePictureBtn5" class="css-3d-btn">&nbsp;&nbsp;本地截屏&nbsp;&nbsp;
                          </button>
                          <br>
                        </td>
                      </tr>
                    </table>
                  </div>
                </td>
              </tr>
            </table>
          </div>
        </div>
      </td>
    </tr>
    <!--房间与会者列表信息-->
    <tr>
      <td>
        <div id="part-of-screen-to-be-shared">
          <button class="button green rarrow" onclick="show('a4')" style="width:180px">【房间与会者列表信息】
          </button>
          <div id="a4" style="display:none">
            <div>
              <table id="participants_table" class="table" border="1" width="1102">
                <thead>
                  <tr>
                    <th>uid</th>
                    <th>feedId</th>
                    <th>tag</th>
                    <th>mediaSource</th>
                    <th>订阅</th>
                  </tr>
                </thead>
                <tbody>
                </tbody>
              </table>
            </div>
          </div>
          <br>
        </div>
      </td>
    </tr>

    <!--    订阅窗口-->
    <tr id="subscribe" style="display: none">
      <td>
        <button class="button green rarrow" onclick="show('a5')" style="width:110px">【订阅窗口】</button>

        <div id="a5" style="display:none">
          <input type="number" id="subscribeNumber" value=3>
          <button id="updateSubscribeAmount" class="css-3d-btn">&nbsp;变更窗口数量&nbsp;</button>
          <div style="float:left;width:100%;height:33%;border:0.1px solid"></div>
        </div>
        <br>
      </td>
    </tr>
    <!--点播-->
    <tr>
      <td>
        <button class="button green rarrow" onclick="show('a6')" style="width:80px">【点播】</button>
        <div id="a6" style="display:none">
          <div>
            <table width="1000">
              <tr>
                <td>
                  &nbsp;
                  <label text="vod_timeout">开启点播超时时间(秒):</label>
                  <input type="text" id="vod_timeout" value="5" style="width:20px;" />&nbsp;

                  <label text="vod_file">点播文件url:</label>
                  <input type="text" id="vod_file" placeholder="请输入点播文件URL" style="width:580px;" />
                  <br>&nbsp;

                  <button id="start_vod" class="css-3d-btn"
                    onclick="startVod(document.getElementById('vod_file').value)">
                    &nbsp;&nbsp;开启点播&nbsp;&nbsp;
                  </button>
                  <button id="stop_vod" class="css-3d-btn"
                    onclick="stopVod()">&nbsp;&nbsp;停止点播&nbsp;&nbsp;</button>&nbsp;
                  <label id="vod_id_text" class="css-text-color">点播id:</label>
                  <label id="vod_id" class="css-text-color" style="width: 400px"></label>
                </td>
              </tr>
            </table>
          </div><br>
        </div>
      </td>
    </tr>

    <!--    录制窗口-->
    <tr>
      <td>
        <button class="button green rarrow" onclick="show('a7')" style="width:110px">【录制窗口】</button>
        <div id="a7" style="display:none">
          <div>
            <table width="1000">
              <tr>
                <td>
                  <!-- 浏览器录制 -->
                  <div>
                    <label style="color: blue">【浏览器录制】</label>
                    <br>&nbsp;
                    <select name="select_record_media_type" id="select_record_media_type" class="xla_k">
                      <option selected value="1">&nbsp;音视频&nbsp;</option>
                      <option value="2">&nbsp;音频&nbsp;</option>
                      <option value="3">&nbsp;视频&nbsp;</option>
                    </select>&nbsp;

                    <label text="record_videoCodec">视频编码格式:</label>
                    <select name="record_videoCodec" id="record_videoCodec" class="xla_k">
                      <option value="h264" selected>&nbsp;h264&nbsp;</option>
                      <option value="vp8">&nbsp;vp8&nbsp;</option>
                      <option value="vp9">&nbsp;vp9&nbsp;</option>
                    </select>&nbsp;

                    <label text="record_frameRate">帧率:</label>
                    <input type="text" id="record_frameRate" value="20" style="width:30px;" />

                    <label text="record_timeSlice">返回录制结果时间间隔(分):</label>
                    <input type="text" id="record_timeSlice" value="30" style="width:30px;" />&nbsp;

                    <label text="browserRecordResolution">合成视频分辨率:</label>
                    <select name="select" id="browserRecordResolution" class="xla_k">
                      <option value="1920x1080">&nbsp;1080p, 1920x1080, 16:9&nbsp;</option>
                      <option value="1280x720" selected>&nbsp;720p, 1280x720, 16:9&nbsp;</option>
                      <option value="640x360">&nbsp;360p, 640x360, 16:9&nbsp;</option>
                    </select> <br>&nbsp;
                    <div id="client_watermark">
                      <!-- 水印 -->
                      <span>增加水印：</span>
                      <button class="addWatermark" data-type="1-0">时间戳水印</button>
                      <button class="addWatermark" data-type="1-1">文字水印</button>
                      <button class="addWatermark" data-type="1-2">图片水印</button>
                    </div>
                    <br />
                    <button id="startRecordBtn" class="css-3d-btn">&nbsp;&nbsp;开始录制&nbsp;&nbsp;</button> &nbsp;
                    <button id="pauseRecordBtn" class="css-3d-btn">&nbsp;&nbsp;暂停录制&nbsp;&nbsp;</button> &nbsp;
                    <button id="resumeRecordBtn" class="css-3d-btn">&nbsp;&nbsp;恢复录制&nbsp;&nbsp;</button> &nbsp;
                    <button id="stopRecordBtn" class="css-3d-btn">&nbsp;&nbsp;停止录制&nbsp;&nbsp;</button> &nbsp;
                    <button id="downloadRecordBtn" class="css-3d-btn">&nbsp;&nbsp;下载录制&nbsp;&nbsp;</button>
                    <br> &nbsp;
                    <label text="client_record_id" class="css-text-color">浏览器录制id:</label>
                    <label id="client_record_id" class="css-text-color"></label>
                  </div>
                  <br>

                  <hr style="width:100% ">
                  <!-- 服务端录制 -->
                  <div>
                    <label style="color: blue">【服务端录制】</label>
                    <table>
                      <tr>
                        <td>
                          &nbsp;
                          <input id="silentRecord" type="checkbox">静默录制</label>&nbsp;

                          <label for="recordTag">自定义标识:</label>
                          <input type="text" id="recordTag" style="width:50px;">&nbsp;

                          <label text="record_width:">宽:</label>
                          <input type="text" id="record_width" value="1280" style="width:30px;" />&nbsp;

                          <label text="record_height:">高:</label>
                          <input type="text" id="record_height" value="720" style="width:30px;" />&nbsp;

                          <label text="record_crf:">清晰度:</label>
                          <input type="number" id="record_crf" value="38" max="50" min="25" style="width:30px;" />&nbsp;

                          <label>结束类型:</label>
                          <select id="record_endType" class="xla_k">
                            <option value="0">&nbsp;调用者退出时&nbsp;</option>
                            <option value="1">&nbsp;房间销毁时&nbsp;</option>
                          </select>&nbsp;

                          <label>图层布局:</label>
                          <input type="text" id="record_layoutParam" placeholder="tag1,tag2,tag3,..."
                            style="width:200px;">
                          <br />&nbsp;

                          <label text="tagFilter">录制指定tag:</label>
                          <input type="text" id="tag_filter" placeholder="指定针对某tag的流进行录制，支持前缀匹配" style="width:300px;" />

                          <label text="record_timeout">开启录制超时时间(秒):</label>
                          <input type="number" id="record_timeout" value="10" style="width:30px;" />&nbsp;

                          <label text="recordTotalStream">录制启动成功标准(成功订阅画面数):</label>
                          <input type="number" id="record_total_stream" value="0" style="width:30px;" />
                          <br>&nbsp;

                          <label>自定义存储路径:</label>
                          <input type="text" id="record_filePath" style="width:150px;">&nbsp;

                          <label text="record_splitType:">录制分离:</label>
                          <select id="record_splitType" class="xla_k">
                            <option value="0" selected>&nbsp;不分离&nbsp;</option>
                            <option value="1">&nbsp;A+AV&nbsp;</option>
                            <option value="2">&nbsp;V+AV&nbsp;</option>
                          </select>&nbsp;

                          <label>自定义存储路径(分离文件):</label>
                          <input type="text" id="record_splitFilePath" style="width:150px;">&nbsp;
                          <br>&nbsp;
                          <div id="watermark">
                            <!-- 水印 -->
                            &nbsp;增加水印:
                            <button class="addWatermark" data-type="2-0">时间戳水印</button>
                            <button class="addWatermark" data-type="2-1">文字水印</button>
                            <button class="addWatermark" data-type="2-2">图片水印</button>
                          </div>

                          <!-- tag布局 tag1 -->
                          <div id="tagPosition">
                            &nbsp;TagPosition:
                            <button id="addTagPosition">增加TagPosition</button>
                          </div>
                          <!-- tag布局 tag2 -->
                          <!-- <label text="tag_position_2">TAG对应布局:</label>
                                                    <input type="text" id="tag_position_2" style="width:150px;"/>&nbsp;
                                                    <label text="tag_position_2_x">x坐标:</label>
                                                    <input type="text" id="tag_position_2_x" style="width:30px;" />
                                                    <label text="tag_position_2_y">y坐标:</label>
                                                    <input type="text" id="tag_position_2_y" style="width:30px;" />
                                                    <label text="tag_position_2_width">宽:</label>
                                                    <input type="text" id="tag_position_2_width" style="width:30px;" />
                                                    <label text="tag_position_2_height">高:</label>
                                                    <input type="text" id="tag_position_2_height" style="width:30px;" />
                                                    <br>&nbsp; -->

                          <button id="startRemoteRecord" class="css-3d-btn" onclick="startRemoteRecordBtn()">
                            &nbsp;&nbsp;开始录制&nbsp;&nbsp;
                          </button>&nbsp;&nbsp;
                          <button id="pauseRemoteRecord" class="css-3d-btn"
                            onclick="pauseRemoteRecordBtn(document.getElementById('remoteRecordIDList').value)">
                            &nbsp;&nbsp;暂停录制&nbsp;&nbsp;
                          </button>&nbsp;&nbsp;
                          <button id="resumeRemoteRecord" class="css-3d-btn"
                            onclick="resumeRemoteRecordBtn(document.getElementById('remoteRecordIDList').value)">
                            &nbsp;&nbsp;恢复录制&nbsp;&nbsp;
                          </button>&nbsp;&nbsp;
                          <button id="changeRecordWatermark" class="css-3d-btn"
                            onclick="changeRecordWatermark(document.getElementById('remoteRecordIDList').value)">
                            &nbsp;&nbsp;变更水印&nbsp;&nbsp;
                          </button>&nbsp;&nbsp;
                          <button id="stopRemoteRecord" class="css-3d-btn"
                            onclick="stopRemoteRecordBtn(document.getElementById('remoteRecordIDList').value)">
                            &nbsp;&nbsp;停止录制&nbsp;&nbsp;
                          </button>
                          <label for="remoteRecordIDList">录制ID：</label>
                          <select name="remoteRecordIDList" id="remoteRecordIDList"></select>
                          <br>&nbsp;
                          <label text="record_mediaType:">查看类型:</label>
                          <select id="record_media_type" class="xla_k">
                            <option value="0" selected>&nbsp;音视频&nbsp;</option>
                            <option value="1">&nbsp;纯音频&nbsp;</option>
                            <option value="2">&nbsp;纯视频&nbsp;</option>
                          </select>&nbsp;

                          <label for="new_record_sign">签名:</label>
                          <input type="text" id="new_record_sign" value="signature" />&nbsp;

                          <button id="queryRemoteRecord" class="css-3d-btn"
                            onclick="queryRemoteRecord(document.getElementById('remoteRecordIDList').value)">
                            &nbsp;&nbsp;查看录制信息&nbsp;&nbsp;
                          </button>
                          <br>&nbsp;

                          <!-- 服务端录制id -->
                          <label type="text" class="css-text-color">服务端录制id:</label>
                          <label id="remote_server_record_id" type="text" class="css-text-color"></label><br>&nbsp;
                          <label id="status" type="text" class="css-text-color"></label><br>&nbsp;
                          <label id="fileType" type="text" class="css-text-color"></label><br>&nbsp;
                          <label id="filePath" type="text" class="css-text-color"></label>
                        </td>
                      </tr>
                    </table>
                  </div>
                </td>
              </tr>
            </table>
          </div>
        </div>
        <br>
      </td>
    </tr>

    <!--浏览器录制和截屏-->
    <tr>
      <td>
        <button class="button green rarrow" onclick="show('a8')" style="width:200px">【浏览器录制 / 截屏结果】</button>
        <div id="a8" style="display:none">
          <table width="1000">
            <tr>
              <td>
                <label text="turn">浏览器录制</label>
                <video id="clientRecordPreview" autoplay muted="true" width="auto" height="auto"
                  webkit-playsinline="true" playsinline="true"></video>
              </td>
            </tr>
            <tr>
              <td>
                <label text="turn">本地截屏</label>
                <img id="previewImg" style="visibility:hidden">
              </td>
              <td>
                <label text="turn">对端截屏</label>
                <img id="previewImgRemote" style="visibility:hidden">
              </td>
            </tr>
          </table>
        </div><br>
      </td>
    </tr>
  </table>
</body>

</html>
<script>

</script>
<script type="text/javascript" src="https://gw.alipayobjects.com/os/lib/jquery/3.5.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.2"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix@2.0"></script>
<!-- 全局通过script引用 -->
<script src="./lib/adapter.js"></script>
<script src="./lib/getMediaInfo.js"></script>
<script src="./lib/beauty/beauty.js"></script>
<script src="./lib/beauty/meeting_beautify_stream.js"></script>
<script src="./lib/beauty/backgroundBlur.js"></script>
<script src="./lib/pdf.js"></script>
<script src="./lib/EBML.js"></script>
<script src="./lib/dom-to-image.js"></script>
<script src="./lib/eruda.js"></script>

<!-- file引用 -->
<script src="./lib/mcu.js"></script>
<script src="./lib/meeting_desk_stream.js"></script>
<script src="./lib/meeting_html_stream.js"></script>
<script src="./lib/meeting_file_stream.js"></script>
<script src="./lib/meeting_im.js"></script>
<script src="./lib/meeting_vod.js"></script>
<script src="./lib/meeting_invite.js"></script>
<script src="./lib/client_record.js"></script>
<script src="./lib/remote_record.js"></script>
<script src="./lib/meeting_camera_stream.js"></script>
<script src="./lib/meeting_api.js"></script>


<script type="module">
  renderSvcOptions()
  function renderSvcOptions() {
    let arr = ["NONE", "L1T2", "L1T3", "L2T1", "L2T1h", "L2T1_KEY", "L2T2", "L2T2_KEY", "L2T2_KEY_SHIFT", "L2T3_KEY", "L3T1", "L3T3", "L3T3_KEY"];
    let optionsArr = []
    arr.forEach(item => {
      optionsArr.push("<option value=" + item + ">" + item + "</option>")
    });
    $("#scalabilityMode").html(optionsArr.join("")).children().eq(0).attr("selected", "selected");
  }
  let svcOptions =
    window.pauseVideo = function (sid) {
      test_controller.PauseFile(sid);
    }
  window.playVideo = function (sid) {
    test_controller.PlayFile(sid);
  }
  let addNewPublish = document.querySelector('#addNewPublish');
  let additional_publish = document.querySelector('#additional_publish');
  function toggleNewPublishWindow() {
    show('additional_publish');
  }
  window.show = function (c_Str) {
    if (document.all(c_Str).style.display == 'none') {
      document.all(c_Str).style.display = 'block';
    } else {
      document.all(c_Str).style.display = 'none';
    }
  }

  //双人模式
  window.duetMode = function () {
    if (room_state) {
      alert("请先退出房间");
      return;
    }
    if (document.all("subscribe").style.display == 'block') {
      duet = true;
      document.all("subscribe").style.display = 'none';
    }
    //双人通话,展示发布框的右侧信息
    alwaysShow("duet_subscribe");
    let publishWindow = document.getElementById("publish_window");
    publishWindow.innerText = "【发布订阅窗口】";
    publishWindow.style.width = '130px';
    alwaysShow("a0");
    alwaysShow("a1");
    alwaysShow("a2");
    $("#a5>div").html("");
  }
  let subscribeAmount = 3;
  createSubscribeDiv();
  //多人模式
  window.multiplayerMode = function () {
    if (room_state) {
      alert("请先退出房间");
      return;
    }
    if (document.all("subscribe").style.display == 'none') {
      duet = false;
      document.all("subscribe").style.display = 'block';
      document.all("subscribe").style.border = "none";
    }
    //多人通话,隐藏发布框的右侧信息
    alwaysNone("duet_subscribe");
    let publishWindow = document.getElementById("publish_window");
    publishWindow.innerText = "【发布窗口】";
    publishWindow.style.width = '110px';
    alwaysShow("a0");
    alwaysShow("a1");
    alwaysShow("a2");
    createSubscribeDiv();
  };
  //增加多人订阅窗口
  function createSubscribeDiv() {
    $("#a5>div").html("");
    subscribeAmount = $("#subscribeNumber").val();
    let container = $("#a5>div");
    for (let i = 1; i <= subscribeAmount; i++) {
      let htmlStr = `<div style="float:left;width:25%;height:100%;border:0.1px solid">
                              <div style="float:left;width:100%;height:60%;border:0.1px solid">
                                  <canvas id="subscribe_volumeView${i}" width="20%" height="100%"></canvas>
                                  <video id="video${i}" autoplay playsinline muted="true" width="80%" height="100%"
                                      webkit-playsinline="true" playsinline="true">video</video>
                                  <audio id="audio${i}" autoplay>音频</audio>
                                  <br>
                                  <label type="text">&nbsp;&nbsp;feedId:</label>
                                  <label id="feedId${i}" class="css-text-color" type="text"></label>
                                  <br>
                                  <label type="text">&nbsp;&nbsp;streamId:</label>
                                  <label id="subscribe_streamId${i}" class="css-text-color" type="text"></label>
                              </div>
                              <div style="float:left;width:100%;height:40%;border:0.1px solid">
                                  <button class="css-3d-btn"
                                      onclick="takePictureRemoteBtn(document.getElementById('video${i}').name, 'png')">&nbsp;截屏&nbsp;</button>
                                  <button class="css-3d-btn"
                                      onclick="unSubscribeButton(document.getElementById('video${i}').name || document.getElementById('audio${i}').name)">&nbsp;取消订阅&nbsp;</button>
                                  <button class="css-3d-btn img-fullscreen"
                                      onclick="requestFullScreen(document.getElementById('video${i}'))">&nbsp;全屏&nbsp;</button>
                              </div>
                          </div>
            `
      container.append(htmlStr)
    }
  }
  $('#updateSubscribeAmount').on("click", createSubscribeDiv);
  //设置元素展示
  function alwaysShow(c_Str) {
    document.all(c_Str).style.display = 'block';
  }

  function alwaysShowInline(c_Str) {
    document.all(c_Str).style.display = 'inline';
  }

  //设置元素隐藏
  function alwaysNone(c_Str) {
    document.all(c_Str).style.display = 'none';
  }

  //调整publish_device1的值
  window.publishDeviceChange1 = function () {
    let publishDevice = $("#publish_device").val();
    $("#publish_device1").val(publishDevice);
    if (publishDevice == "3") {
      $('#v_file1').show();
      $('#canvas_video_box').show();
      $('#playVideo').show();
      $('#pauseVideo').show();
    } else {
      $('#v_file1').hide();
      $('#canvas_video_box').hide();
      $('#playVideo').hide();
      $('#pauseVideo').hide();
    }
  }

  //调整publish_device的值
  window.publishDeviceChange2 = function () {
    let publishDevice = $("#publish_device1").val();
    $("#publish_device").val(publishDevice);
    if (publishDevice == "3") {
      $('#v_file1').show();
      $('#canvas_video_box').show();
      $('#playVideo').show();
      $('#pauseVideo').show();
    } else {
      $('#v_file1').hide();
      $('#canvas_video_box').hide();
      $('#playVideo').hide();
      $('#pauseVideo').hide();
    }
  }

  window.publishDeviceChange3 = function () {
    let publishDevice = $("#publish_device5").val();
    if (publishDevice == "3") {
      $('#v_file5').show();
    } else {
      $('#v_file5').hide();
    }
  }

  // 初始化信息
  let httpsFixButton = document.getElementById("httpsFixButton");
  let mute_Audio = document.getElementById("mute-audio");
  let mute_Video = document.getElementById("mute-video");

  let takePictureBtn = document.getElementById("takePictureBtn");
  let btnStartRecording = document.getElementById("startRecordBtn");
  let btnPauseRecording = document.getElementById("pauseRecordBtn");
  let btnResumeRecording = document.getElementById("resumeRecordBtn");
  let btnStopRecording = document.getElementById("stopRecordBtn");
  let btnDownloadRecording = document.getElementById("downloadRecordBtn");
  const localVideo = document.getElementById('publish_video1');
  let publish_device = parseInt($("#publish_device").val());

  //默认双人模式
  let duet = true;
  // let asr_procType = 8;
  let client_cost_time = 0;
  let stream_duration_timer = -1;
  let mediaInfo;
  let hideIconsAfterTimeout;
  let role = "";
  //生成uid
  function addPreZero(num) {
    var t = (num + '').length,
      s = '';

    for (var i = 0; i < 4 - t; i++) {
      s += '0';
    }

    return s + num;
  }
  let randomNum = Math.floor(Math.random() * 10000);
  $('#uid').val(addPreZero(randomNum))
  // 实例化SDK
  let test_controller = new McuController();
  let conn_state = 0;
  let room_state = 0;
  let vod_state = 0;

  if (!publish_device) {
    publish_device = 1;
  }

  // ###### 建立连接/断开连接 ######
  // 建立连接
  $("#connectButton").click(function () {

    //已连接,直接返回
    if (conn_state == 1) {
      return;
    }
    let biz_name = $("#biz_name").val();
    let sub_biz = $("#sub_biz").val();
    let uid = $("#uid").val();
    let workspaceId = $("#workspaceId").val();
    let select_room = $("#select_room").val();

    let config_param = {};
    config_param.uid = uid;
    config_param.biz_name = biz_name;
    config_param.sub_biz = sub_biz;
    config_param.workspaceId = workspaceId;
    config_param.room_server_url = select_room;
    config_param.sign = getSign(uid);
    // 允许最大断网时间 (超过未重连, 直接关闭)
    config_param.network_check_timeout = 120 * 1000;
    test_controller.Connect(config_param);
  });

  // 断开连接
  $("#disconnectButton").click(function () {

    if (conn_state == 0) {
      return;
    }
    test_controller.Disconnect();
  });


  //建立连接失败回调
  test_controller.OnConnectFailed = function (code, msg) {
    conn_state = 0;
    alert("建立连接失败, 请尝试https修复");
    document.getElementById("conn_state").innerText = "初始化失败: " + msg;
  };
  test_controller.OnPlayVideoSuccess = function () {
    console.log("play video 成功")
  };
  test_controller.OnPauseVideoSuccess = function () {
    console.log("pause video 成功")
  }
  // 切流成功回调
  test_controller.OnChangeMediaStreamSuccess = function (sid) {
    console.log("change media success")
    let publishDevice = $('#publish_device').val();
    if (publishDevice != 1) {
      $('#publish_video1').removeClass('mirror');
      clearStreamRemain()
    } else {
      $('#publish_video1').addClass('mirror');
    };

  }
  // https证书问题修复
  httpsFixButton.onclick = function () {
    let room_server_sel = $("#select_room").val();
    if (room_server_sel.indexOf('wss://') == 0) {
      window.open(room_server_sel.replace('wss://', 'https://').replace('/ws', ''), '_blank', '');
    } else {
      alert("当前服务器地址不需要https修复");
    };
  };

  //建立连接成功回调
  test_controller.OnConnectOK = function () {
    conn_state = 1;
    document.getElementById("conn_state").innerText = "已连接";

  };

  //断开连接回调
  test_controller.OnConnectClose = function (code, msg) {
    conn_state = 0;
    document.getElementById("conn_state").innerText = "断开";
  };

  function setMediaInfo(config_param) {
    let audioSource = audioInputSelect.value;
    let videoSource = videoSelect.value;
    config_param.audioSource = audioSource;
    config_param.videoSource = videoSource;
    config_param.aspectRatioStrongDepend = false;
    config_param.aspectRatio = "0";
  }
  //业务添加美颜等加工Stream
  let beautyDiv = {};
  function clearStreamRemain() {
    if (!(beautyDiv.beauty_canvas == null || beautyDiv.beauty_canvas == undefined)) {
      beautyDiv.beauty_canvas = null;
    }
    if (!(beautyDiv.beauty_player == null || beautyDiv.beauty_player == undefined)) {
      beautyDiv.beauty_player.destroy();
      beautyDiv.beauty_player = null;
    }
    if (!(beautyDiv.beauty_div == null || beautyDiv.beauty_div == undefined)) {
      document.body.removeChild(beautyDiv.beauty_div);
      beautyDiv.beauty_div = null;
    }
    beautyDiv = {};
  };
  function startBeauty(stream) {
    let newStream = stream;
    beautyDiv = meetingBeautifyStream(newStream, parseInt(document.getElementById("beauty_strength").value));
    newStream = beautyDiv.stream;
    return newStream
  }
  async function initBackgroundBlur(stream) {
    let newStream = stream;
    let marsblur = new MarsBlur.MarsBlurFunc();
    let width = stream.getVideoTracks()[0].getSettings().width;
    let height = stream.getVideoTracks()[0].getSettings().height;
    let streamObj = await marsblur.backgroundBlur(stream, {
      url: $('#blurURL').val(),
      local_video_width: width,
      local_video_height: height,
      architecture: 'MobileNetV1',
      outputStride: 16,
      multiplier: 0.5,
      quantBytes: 2,
      segmentationThreshold: 0.5,
      scoreThreshold: 0.3
    });
    beautyDiv.marsblur = marsblur;
    if (streamObj.result) {
      newStream = streamObj.info
    }
    return newStream
  }
  test_controller.StreamFilterHandler = async function (publish_tag, stream, stream_type, publish_device, media_type) {
    this.trace(`stream processed by client, publish_device=${publish_device}, media_type=${media_type}, publish_tag=${publish_tag},stream_type=${stream_type}`);
    if (stream_type == "subscribe") {
      return stream
    }
    if (media_type == 2 || media_type == 4) {
      return stream
    }
    // if (publish_device != 1) {
    //   return stream
    // }
    let newStream = stream;
    let beauty_strength = parseInt(document.getElementById("beauty_strength").value);
    if (beauty_strength != 0 && stream.getVideoTracks()[0]) {
      newStream = new MediaStream([startBeauty(stream).getVideoTracks()[0]]);
    };
    if (document.getElementById("blurSwitch").checked && stream.getVideoTracks()[0]) {
      if (!$('#blurURL').val()) {
        alert("请提供图片背景URL");
      } else {
        newStream = newStream = new MediaStream([initBackgroundBlur(stream).getVideoTracks()[0]]);
      }
    }
    if (stream.getAudioTracks()[0] && newStream.addTrack) {
      newStream.addTrack(stream.getAudioTracks()[0])
    }
    return newStream
  }
  // ###### 房间相关 #######
  // 初始化房间
  function initRoomInfo() {
    let config_param = {};
    publish_device = parseInt($("#publish_device").val());
    // 发布弱网告警
    test_controller.SetPublishWeakBitrateLimit(parseInt($("#weak_bitrate").val()));
    //订阅发布弱网告警
    test_controller.SetSubscribeWeakBitrateLimit(parseInt($("#remote_weak_bitrate").val()));
    // 编码方式
    let video_codec = $("#select_codec").val();
    if (video_codec != "AUTO") {
      test_controller.SetLocalCodecType($("#select_codec").val());
    }
    config_param.third_id = document.getElementById("third_id").value;
    config_param.auto_publish_subscribe = parseInt($("#auto_publish_subscribe").val());
    let video_profile_type = $("#video_profile_type").val()
    config_param.video_profile_type = video_profile_type;
    if (video_profile_type == 100) {
      config_param.video_profile_diy = {
        width: +$("#video_profile_diy_width").val(),
        height: +$("#video_profile_diy_height").val(),
        frameRate: +$("#video_profile_diy_framerate").val(),
        bitrate: +$("#video_profile_diy_bitrate").val()
      }
    }
    let initPublish = [{
      publish_video_id: "publish_video1",
      publish_streamId_id: "publish_streamId1",
      publish_tag: document.getElementById("publish_tag").value
    }];

    //分业务模式传入订阅参数
    let initSubscribe;
    if (duet) {
      initSubscribe = [{
        subscribe_video_id: "video0",
        subscribe_audio_id: "audio0",
        subscribe_streamId_id: "subscribe_streamId0",
        feedId_id: "feedId0"
      }, {
        subscribe_video_id: "video99",
        subscribe_audio_id: "audio99"
      }];
    } else {
      initSubscribe = [];
      for (let i = 1; i <= subscribeAmount; i++) {
        initSubscribe.push({
          subscribe_video_id: "video" + i,
          subscribe_audio_id: "audio" + i,
          subscribe_streamId_id: "subscribe_streamId" + i,
          feedId_id: "feedId" + i
        })
      }
    }
    config_param.enableVideo = $('#enableVideo').prop("checked");
    config_param.enableAudio = $('#enableAudio').prop("checked");
    config_param.enableDatachannel = $('#enableDatachannel').prop("checked");
    config_param.publish_device = publish_device;
    if (config_param.publish_device == 2) {
      config_param.enableDesktopAudio = $("#enableDesktopAudio").prop("checked");
    }
    switch (config_param.auto_publish_subscribe) {
      case 1:
        //订阅的时候的参数
        config_param.initSubscribe = initSubscribe;
        break;
      case 2:
        //发布的时候的参数
        config_param.initPublish = initPublish;
        setMediaInfo(config_param);
        break;
      case 3:
      case 5:
        config_param.initPublish = initPublish;
        config_param.initSubscribe = initSubscribe;
        setMediaInfo(config_param);
        break;
    }
    config_param.degradationType = +document.getElementById("degradationType").value;

    // 设置录制参数
    config_param.defaultRecord = document.getElementById("defaultRecord").checked;  // 是否默认开始服务端录制,默认为false
    if (config_param.defaultRecord) {
      let recordParam = {};
      recordParam.silentRecord = document.getElementById("silentRecord").checked;
      recordParam.width = parseInt($("#record_width").val());
      recordParam.height = parseInt($("#record_height").val());
      recordParam.recordTotalStream = parseInt($("#record_total_stream").val());
      recordParam.startTimeout = parseInt($("#record_timeout").val());
      recordParam.splitType = parseInt($("#record_splitType").val());
      recordParam.splitFilePath = $("#record_splitFilePath").val();
      recordParam.endType = parseInt($("#record_endType").val());
      recordParam.layoutParam = $("#record_layoutParam").val().split(',');
      recordParam.tagFilter = $("#tag_filter").val();
      // 时间戳水印
      let wmCount = $("#watermark .watermark_head");
      let overlaps = [];
      for (let i = 0; i < wmCount.length; i++) {
        let type = $(wmCount[i]).data("type");
        let arr = $(wmCount[i]).children("input");
        let wm
        if (type == "timestamp") {
          // 时间戳水印
          wm = {
            enable: true,
            type: 1,
            id: +(arr.eq(0).val()),
            xPosition: +(arr.eq(1).val()),
            yPosition: +(arr.eq(2).val()),
            tag: arr.eq(3).val()
          };
        } else if (type == "text") {
          // 文字水印
          wm = {
            enable: true,
            type: 2,
            id: +arr.eq(0).val(),
            xPosition: +arr.eq(1).val(),
            yPosition: +arr.eq(2).val(),
            text: arr.eq(3).val(),
            fontSize: +arr.eq(4).val(),
            tag: arr.eq(5).val()
          }
        } else {
          // 图片水印
          let url;
          if (!arr.eq(3).val()) {
            alert("请选择一个图片")
            return
          }
          wm = {
            enable: true,
            type: 3,
            id: +arr.eq(0).val(),
            xPosition: +arr.eq(1).val(),
            yPosition: +arr.eq(2).val(),
            url: arr.eq(3).val(),
            tag: arr.eq(4).val()
          }
        }
        overlaps.push(wm)
      };
      recordParam.overlaps = overlaps;
      // 清晰度
      recordParam.crf = parseInt(document.getElementById("record_crf").value);

      config_param.recordParam = recordParam;
      config_param.record_third_id = $("#recordTag").val();
      config_param.recordStrongDepend = document.getElementById("recordStrongDepend").checked;    // 是否强依赖录制
      config_param.filePath = $("#record_filePath").val();
    }
    //是否需要实时音量值,默认为false
    config_param.need_volume_analyser = true;
    // 中转相关
    config_param.transport_ = document.getElementById("transport_").value;
    config_param.defaultTurnServer = document.getElementById("default_turn_server").value;
    // E2EE
    let E2EE = {};
    E2EE.E2EE_enable = document.getElementById("E2EE_enable").checked;
    E2EE.E2EE_ikm = document.getElementById("E2EE_ikm").value;
    config_param.E2EE = E2EE;
    // sknm
    config_param.sknm = document.getElementById("sknm").value;
    // 预热摄像头+麦克风
    if ((config_param.enableVideo || config_param.enableAudio)
      && (config_param.auto_publish_subscribe == 2 || config_param.auto_publish_subscribe == 3)
      && config_param.publish_device == 1) {
      test_controller.PreOpenLocalMedia(config_param);
    }

    config_param.enableDataChannel = $("#enableDataChannel").prop("checked");
    config_param.engine = parseInt($("#engine").val());
    config_param.scalabilityMode = $("#scalabilityMode").val();
    test_controller.InitRoomConfig(config_param);
  }

  // 初始化成功回调
  test_controller.OnInitRoomConfigOK = function () {
    if (role == "caller") {
      test_controller.CreateRoom(getSign($("#uid").val()));
    } else if (role == "callee") {
      let room_id = $("#room_id").val().trim();
      let rtoken = $("#rtoken").val();
      test_controller.JoinRoom(room_id, rtoken, getSign($("#uid").val()));
    }
  };

  // 创建房间
  $("#createButton").click(function () {
    if (conn_state == 0) {
      alert("请先建立连接");
      return;
    }
    role = "caller";
    if (room_state != 0) {
      return;
    }
    this.room_state = "create_room";
    initRoomInfo();
  });

  // 创建房间成功回调
  test_controller.OnCreateRoomSucc = function (room_id, rtoken) {
    document.getElementById("room_id").value = room_id;
    document.getElementById("rtoken").value = rtoken;
    room_state = 1;
    document.getElementById("join_room_state").innerText = "是";
    alwaysNone("a0");
    alwaysShow("a2");
    alwaysShow("a3");
    alwaysShow("a4");
  };


  // 加入房间
  $("#joinButton").click(function () {
    if (conn_state == 0) {
      alert("请先建立连接");
      return;
    }
    if (room_state != 0) {
      return;
    }
    role = "callee";
    initRoomInfo();
  });

  // 加入房间成功
  test_controller.OnJoinRoomSucc = function () {
    room_state = 1;
    document.getElementById("join_room_state").innerText = "是";
    alwaysNone("a0");
    alwaysShow("a2");
    alwaysShow("a3");
    alwaysShow("a4");
  };

  // 邀请加入
  $("#inviteButton").click(function () {
    if (conn_state == 0) {
      alert("请先建立连接");
      return;
    }
    if (room_state == 0) {
      alert("请先创建房间");
      return;
    }
    let invitee = $("#invitee").val();
    let invitationChannelType = parseInt($("#invitation_channel_type").val());
    let invitationLink = $("#invitation_link").val();
    if (!invitee || invitee == "") {
      alert("请填入被邀请者uid");
      return;
    }
    if (isNaN(invitationChannelType)) {
      alert("invitationChannelType is NaN");
      return;
    }
    test_controller.Invite(invitee, invitationChannelType, invitationLink);
  });


  // 邀请成功
  test_controller.OnInviteOK = function () {
    document.getElementById("invite_state").innerText = "邀请成功";
  };

  // 邀请失败
  test_controller.OnInviteFail = function (code, msg) {
    document.getElementById("invite_state").innerText = "邀请失败";
  };


  // 被邀请
  test_controller.OnInviteRequest = function (room_id, rtoken, inviter, extra, inviteId, inviteInfo) {
    let media_inviteInfo = {};
    if (inviteInfo) {
      media_inviteInfo.audioEnable = inviteInfo.audioEnable;
      media_inviteInfo.videoEnable = inviteInfo.videoEnable;
    }

    if (confirm("用户[" + inviter + "]邀请你加入房间[" + room_id + "], 是否接受?")) {
      role = "callee";
      document.getElementById("room_id").value = room_id;
      document.getElementById("rtoken").value = rtoken;
      test_controller.ReplyInvite(room_id, inviter, 0, inviteId, media_inviteInfo, extra);
      initRoomInfo();
    } else {
      test_controller.ReplyInvite(room_id, inviter, 2, inviteId, media_inviteInfo, extra);
    }
  };

  // 退出房间
  $("#endButton").click(function () {
    if (room_state == 0) {
      alert("当前不在房间中");
      return;
    }
    test_controller.LeaveRoom();
  });


  // 退出房间回调
  test_controller.OnLeaveRoom = function (leaveType) {
    test_controller.warning(`~~~~~~~~~~~~~ leave room! leaveType = ${leaveType}`);
    room_state = 0;
    document.getElementById("room_id").value = "";
    document.getElementById("rtoken").value = "";
    document.getElementById("invitee").value = "";

    document.getElementById("invite_state").innerText = "";
    document.getElementById("join_room_state").innerText = "否";
    document.getElementById("remote_server_record_id").innerText = "";
    document.getElementById("remoteRecordIDList").innerText = "";

    document.getElementById("status").innerText = "";
    document.getElementById("fileType").innerText = "";
    document.getElementById("filePath").innerText = "";

    document.getElementById("streamId_text").style.display = "none";

    // clearTtsInfo();

    if (publish_device == 3) {
      localVideo.src = "";
    }

    $("#vod_id").text("");

    //清空与会者列表
    $("#participants_table tbody tr").each(function () {
      if ($(this).find("td").eq(0).html()) {
        $(this).remove();
      }
    });
    clearInterval(publish_media_stat_timer_id);
    publish_media_stat_timer_id = -1;
    document.getElementById("publish_media_stat1").innerText = "";
    if (subscribe_media_stat_timer_id != -1) {
      clearInterval(subscribe_media_stat_timer_id);
      subscribe_media_stat_timer_id = -1;
      document.getElementById("subscribe_media_stat1").innerText = "";
    }
    alwaysNone("a3");
    alwaysShow("a0");
    alwaysShow("a1");
    alwaysShow("a2");
  };

  //房间与会者列表信息
  test_controller.OnRoomAttendanceList = function (participants) {
    otherUid = participants[0].uid;
    for (var i = 0; i < participants.length; i++) {
      let part = participants[i];
      let publishs = part.publish;
      if (publishs.length != 0) {
        for (var j = 0; j < publishs.length; j++) {
          let publish = publishs[j];
          let result = "";
          result += "<tr>";
          result += "<td>" + part.uid + "</td>";
          result += "<td>" + publish.feedId + "</td>";
          result += "<td>" + publish.tag + "</td>";
          result += "<td>" + publish.mediaSource + "</td>";
          result += "<td><button class='css-3d-btn' onclick='subscribeButton(\"" + publish.feedId + "\")'>订阅</button></td>";
          result += "</tr>";
          $("#participants_table tbody").append(result);
        }
      }
    }
  };

  //推送“退出房间者”给与会者
  test_controller.OnParticipantLeaveRoom = function (uid, exitType) {
    this.warning(`~~~~~~~~~~~~~ user ${uid} left room! exitType=${exitType}`);
    $("#participants_table tbody tr").each(function () {
      if ($(this).find("td").eq(0).html() == uid) {
        $(this).remove();
        otherUid = undefined;
      }
    });
  };
  //共享屏幕关闭
  test_controller.OnDesktopDisplayClosed = function () {
    console.log(`共享屏幕关闭`)
  };
  //共享文件关闭回调
  test_controller.OnFileStreamClosed = function () {
    console.log(`共享文件关闭`)
  };

  // 签名(通道建连/创建房间/加入房间需要)
  function getSign(uid, isRecord = false) {
    test_controller.trace(`GetSign uid=${uid}`);
    if ($("#biz_name").val() == "demo") {
      return 'signature';
    }
    let new_sign = isRecord ? $("#new_record_sign").val() : $("#new_sign").val();
    if (!new_sign) {
      alert("请重写签名");
    }
    return new_sign;
  }

  // ###### 发布订阅相关 ######
  var publish_media_stat_timer_id = -1;
  var subscribe_media_stat_timer_id = -1;
  // 发布流
  async function publish(count) {
    let config_param = {};
    config_param.need_volume_analyser = true;
    config_param.publish_video_id = "publish_video" + count;
    config_param.publish_streamId_id = "publish_streamId" + count;
    let video_profile_type = $("#video_profile_type").val();
    publish_device = parseInt($("#publish_device" + count).val());
    if (publish_device == 5) {
      // 自定义
    } else if (publish_device == 2) {
      config_param.video_profile_type = video_profile_type;
      if (video_profile_type == 100) {
        config_param.video_profile_diy = {
          width: $("#video_profile_diy_width").val(),
          height: $("#video_profile_diy_height").val(),
          frameRate: $("#video_profile_diy_framerate").val(),
          bitrate: +$("#video_profile_diy_bitrate").val()
        }
      }
      config_param.need_volume_analyser = false;
      config_param.enableDesktopAudio = $("#enableDesktopAudio").prop("checked");
    } else if (publish_device == 3) {
      //发布文件
      config_param.video_profile_type = video_profile_type;
      if (video_profile_type == 100) {
        config_param.video_profile_diy = {
          width: +$("#video_profile_diy_width").val(),
          height: +$("#video_profile_diy_height").val(),
          frameRate: +$("#video_profile_diy_framerate").val(),
          bitrate: +$("#video_profile_diy_bitrate").val()
        }
      }
      config_param.need_volume_analyser = false;
      let file = document.getElementById('v_file' + count).files[0];
      if (!file) {
        alert("未选择文件");
        return;
      }
      config_param.file = file;
      config_param.draw_file_video_2_canvas = document.getElementById('draw_file_video_2_canvas').checked;
    } else if (publish_device == 4) {
      config_param.need_volume_analyser = false;
      //传入需要共享区域的id
      config_param.part_of_screen_id = "part-of-screen-to-be-shared";
      let partOfScreenId = config_param.part_of_screen_id;
      let elementById = document.getElementById(partOfScreenId);
      if (!partOfScreenId || !elementById) {
        alert("未选定共享区域");
        return;
      }
    } else {
      setMediaInfo(config_param);
      config_param.video_profile_type = video_profile_type;
      if (video_profile_type == 100) {
        config_param.video_profile_diy = {
          width: $("#video_profile_diy_width").val(),
          height: $("#video_profile_diy_height").val(),
          frameRate: $("#video_profile_diy_framerate").val(),
          bitrate: +$("#video_profile_diy_bitrate").val()
        }
      }
    }
    config_param.publish_tag = document.getElementById("publish_tag").value;
    config_param.enableVideo = $('#enableVideo').prop("checked");
    config_param.enableAudio = $('#enableAudio').prop("checked");
    config_param.enableDatachannel = $('#enableDatachannel').prop("checked");
    config_param.publish_device = publish_device;
    config_param.audioSource = audioInputSelect.value;
    config_param.videoSource = videoSelect.value;
    // 自定义中转
    config_param.transport_ = document.getElementById("transport_").value;
    config_param.defaultTurnServer = document.getElementById("default_turn_server").value;
    config_param.degradationType = +document.getElementById("degradationType").value;
    config_param.scalabilityMode = $("#scalabilityMode").val();
    //业务自己处理sid
    let sid = test_controller.Publish(config_param);
  }

  // 发布流
  window.publishMedia = function (count) {
    if (conn_state == 0) {
      alert("请先建立连接");
      return;
    }

    if (room_state == 0) {
      alert("当前不在房间中");
      return;
    }
    publish(count);
  }

  //发布成功回调
  test_controller.OnPublishSucc = function (sid) {
    test_controller.trace(`stream publish success,sid=${sid}`);
    let publishDevice = $("#publish_device").val();
    if (publishDevice == "1") {
      // alwaysShow("publish_asr");
      alwaysShowInline("mute-audio");
      alwaysShowInline("publish_volumeView");
    } else {
      // alwaysNone("publish_asr");
      alwaysNone("mute-audio");
      alwaysNone("publish_volumeView");
    };

    closeClass(mute_Audio);
    closeClass(mute_Video);
    document.getElementById("streamId_text").style.display = "inline";
    document.getElementById("status").innerText = "";
    document.getElementById("fileType").innerText = "";
    document.getElementById("filePath").innerText = "";

    //隐藏窗口
    alwaysShow("a3");
    if (publishDevice != 1) {
      $('#publish_video1').removeClass('mirror');
    } else {
      $('#publish_video1').addClass('mirror');
    }
    let icons = document.getElementById("icons");
    icons.classList.remove("hidden");

    icons.onmouseenter = function () {
      window.clearTimeout(hideIconsAfterTimeout);
    }.bind(this);

    function clearActive() {
      hideIconsAfterTimeout = window.setTimeout(function () {
        if (icons.classList.contains('active')) {
          icons.classList.remove("active");
        }
      }.bind(this), 5000);
    }

    icons.onmouseleave = function () {
      clearActive.call(this);
    }.bind(this);

    window.onmousemove = function () {
      if (!icons.classList.contains('active')) {
        icons.classList.add("active");

        if (hideIconsAfterTimeout) {
          window.clearTimeout(hideIconsAfterTimeout);
        }
        clearActive.call(this);
      }
    }

    let mediaInfo = generateMediaInfo(sid);
    publish_media_stat_timer_id = setInterval(() => {
      test_controller.GetStats(mediaInfo).then(media_stat => {
        // 分辨率、帧率
        let googAvailableSendBandwidth = (media_stat["VideoBwe"]["googAvailableSendBandwidth"] / 1000).toFixed(2);
        let googTransmitBitrate = (media_stat["VideoBwe"]["googTransmitBitrate"] / 1000).toFixed(2);
        let ssrcVideoSendLostRate = media_stat["ssrcVideoSend"]["lostRate"];
        let ssrcAudioSendLostRate = media_stat["ssrcAudioSend"]["lostRate"];
        let weak_googAvailableSendBandwidth = parseInt($("#weak_bitrate").val());
        let weak_ssrcVideoSendLostRate = parseInt($("#weak_video_lost_rate").val());
        let weak_ssrcAudioSendLostRate = parseInt($("#weak_audio_lost_rate").val());
        let weak_str = "网络正常";
        if (googAvailableSendBandwidth < weak_googAvailableSendBandwidth) {
          weak_str = "当前网络不佳";
        }
        let str =
          "带宽评估:" + (googAvailableSendBandwidth == undefined ? "none" : googAvailableSendBandwidth + "kbps") + "; "
          + "视频码率:" + (media_stat.ssrcVideoSend["bpsSend"] / 1000).toFixed(2) + "kb" + "; "
          + "音频码率:" + (media_stat.ssrcAudioSend["bpsSend"] / 1000).toFixed(2) + "kb" + "; "
          + "视频丢包率:" + (ssrcVideoSendLostRate == undefined ? "none" : ssrcVideoSendLostRate + "%") + "; "
          + "音频丢包率:" + (ssrcAudioSendLostRate == undefined ? "none" : ssrcAudioSendLostRate + "%") + "; "
          + weak_str + "; "
          + "当前编码格式:" + media_stat["ssrcVideoSend"].googCodecName + "; "
          + "分辨率:" + media_stat["ssrcVideoSend"].resolution + "; "
          + "帧率:" + media_stat["ssrcVideoSend"].googFrameRateSent;
        document.getElementById("publish_media_stat1").innerText = str;
      });
    }, 2000);
  };


  //订阅成功回调
  test_controller.OnSubscribeSucc = function (feedId, sid) {
    test_controller.trace(`~~~~~~~~~~~~~ OnSubscribeSuccess  Response  , sid=${sid},feedId=${feedId}`);
    alwaysNone("a0");
    alwaysShow("a3");
    if (duet) {
      document.getElementById("subscribe_feedId_text0").style.display = "inline";
      document.getElementById("subscribe_streamId_text0").style.display = "inline";
    }
    //如果是双人模式,展示订阅窗口
    if (!duet) {
      alwaysShow("a4");
      alwaysShow("a5");
    };
    if (duet) {
      let mediaInfo = generateMediaInfo(sid);
      subscribe_media_stat_timer_id = setInterval(() => {
        test_controller.GetStats(mediaInfo).then(media_stat => {
          let googAvailableRecvBandwidth = (media_stat["VideoBwe"]["googAvailableSendBandwidth"] / 1000).toFixed(2);
          let googTransmitBitrate = (media_stat["VideoBwe"]["googTransmitBitrate"] / 1000).toFixed(2);
          let ssrcVideoRecvLostRate = media_stat["ssrcVideoRecv"]["lostRate"];
          let ssrcAudioRecvLostRate = media_stat["ssrcAudioRecv"]["lostRate"];
          let weak_googAvailableRecvBandwidth = parseInt($("#weak_bitrate").val());
          let weak_ssrcVideoRecvLostRate = parseInt($("#weak_video_lost_rate").val());
          let weak_ssrcAudioRecvLostRate = parseInt($("#weak_audio_lost_rate").val());
          let weak_str = "网络正常";
          if (googAvailableRecvBandwidth < weak_googAvailableRecvBandwidth) {
            weak_str = "当前网络不佳";
          }
          let str =
            "视频码率:" + (media_stat.ssrcVideoRecv["bpsRecv"] / 1000).toFixed(2) + "kb; "
            + "音频码率:" + (media_stat.ssrcAudioRecv["bpsRecv"] / 1000).toFixed(2) + "kb; "
            + "视频丢包率:" + (ssrcVideoRecvLostRate == undefined ? "none" : ssrcVideoRecvLostRate + "%") + "; "
            + "音频丢包率:" + (ssrcAudioRecvLostRate == undefined ? "none" : ssrcAudioRecvLostRate + "%") + "; "
            + weak_str + "; "
            + "当前编码格式:" + media_stat["ssrcVideoRecv"].googCodecName + "; "
            + "分辨率:" + media_stat["ssrcVideoRecv"].resolution + "; "
            + "帧率:" + media_stat["ssrcVideoRecv"].googFrameRateReceived;
          document.getElementById("subscribe_media_stat1").innerText = str;
        })
      }, 2000)
    }
  };

  //有新发布推送,对表格做更新操作
  test_controller.OnNewPublish = function (feed) {
    let trTemp = $("<tr></tr>");
    trTemp.append("<td >" + feed.uid + "</td>");
    trTemp.append("<td >" + feed.feedId + "</td>");
    trTemp.append("<td >" + feed.tag + "</td>");
    trTemp.append("<td >" + feed.mediaSource + "</td>");
    trTemp.append("<td><button class='css-3d-btn' onclick='subscribeButton(\"" + feed.feedId + "\")'>订阅</button></td>");
    trTemp.appendTo("#participants_table tbody");
  };
  //有新加入的回调
  let otherUid;
  test_controller.OnNewJoinerIn = function (participant) {
    console.log(`~~~~~~~~~~~~~ OnNewJoinerIn push, participant=${participant}`);
    otherUid = participant;
  }
  //订阅流
  window.subscribeButton = function (feedId) {
    if (conn_state == 0) {
      alert("请先建立连接");
      return;
    }
    if (room_state == 0) {
      alert("当前不在房间中");
      return;
    }

    //设置订阅需要的参数
    let config_param = {};
    let index = 1;
    for (var i = 1; i <= subscribeAmount; i++) {
      let sid = document.getElementById("video" + i).name;
      if (!sid) {
        index = i;
        break;
      }
    }
    //分业务模式传入订阅参数
    if (duet) {
      //订阅的时候的参数
      config_param.subscribe_video_id = "video0";
      config_param.subscribe_audio_id = "audio0";
      config_param.subscribe_streamId_id = "subscribe_streamId0";
      config_param.feedId_id = "feedId0";
      config_param.need_volume_analyser = true;
    } else {
      //订阅的时候的参数
      config_param.subscribe_video_id = "video" + index;
      config_param.subscribe_audio_id = "audio" + index;
      config_param.subscribe_streamId_id = "subscribe_streamId" + index;
      config_param.feedId_id = "feedId" + index;
      config_param.need_volume_analyser = true;
    }
    config_param.feedId = feedId;
    //业务自己处理sid
    var sid = test_controller.Subscribe(config_param);
  }


  // 取消发布流
  window.unPublish = function (sid) {
    if (conn_state == 0) {
      alert("请先建立连接");
      return;
    }
    if (room_state == 0) {
      alert("当前不在房间中");
      return;
    }
    if (!sid) {
      alert("未发布");
      return;
    }
    test_controller.UnPublish(parseInt(sid));
  }

  //取消发布成功回调
  test_controller.OnUnPublishSucc = function (sid) {
    this.trace(`~~~~~~~~~~~~  OnUnPublishSucc  response, sid=${sid}`);
    document.getElementById("streamId_text").style.display = "none";
    let icons = document.getElementById("icons");
    if (icons.classList.contains('active')) {
      icons.classList.remove("active");
    }
    window.onmousemove = null;
    clearInterval(publish_media_stat_timer_id);
    publish_media_stat_timer_id = -1;
    document.getElementById("publish_media_stat1").innerText = "";
    clearStreamRemain()
  };

  //取消订阅成功回调
  test_controller.OnUnSubscribeSucc = function (sid) {
    this.trace(`~~~~~~~~~~~~  OnUnSubscribeSucc  response, sid=${sid}`);
    if (subscribe_media_stat_timer_id != -1) {
      clearInterval(subscribe_media_stat_timer_id);
    }
  };

  // 取消订阅流
  window.unSubscribeButton = function (sid) {
    if (conn_state == 0) {
      alert("请先建立连接");
      return;
    }
    if (room_state == 0) {
      alert("当前不在房间中");
      return;
    }
    if (sid) {
      test_controller.UnSubscribe(parseInt(sid));
    } else {
      return 0;
    }
  }

  //推送取消发布信息
  test_controller.OnUnPublish = function (feed) {
    let feedId = feed.feedId;
    //删除已取消的发布的订阅行
    $("#participants_table tbody tr").each(function () {
      if ($(this).find("td").eq(1).html() == feedId) {
        $(this).remove();
      }
    });
  };
  //接收对端事件
  test_controller.OnParticipantEvent = function (participant_uid, event_code, event_msg, event_extra) {
    this.trace(`~~~~~~~~~~~~~ participant ${participant_uid} report an event: event_code:${event_code}, event_msg:${event_msg}, event_extra:${JSON.stringify(event_extra)}`)
  }
  // ###### 开关麦克风  开关摄像头 ######
  // 开麦和关麦 1:开;0:关
  mute_Audio.onclick = function () {
    if (checkStatus()) {
      return false;
    }
    let sid = document.getElementById('publish_video1').name || document.getElementById('publish_streamId1').name;
    if (sid) {
      if (mute_Audio.classList.contains('on')) {
        mute_Audio.classList.remove('on');
        test_controller.SetLocalAudioEnable(1, parseInt(sid));
      } else {
        mute_Audio.classList.add('on');
        test_controller.SetLocalAudioEnable(0, parseInt(sid));
      }
    }
  };

  function closeClass(mute_media) {
    if (mute_media.classList.contains('on')) {
      mute_media.classList.remove('on');
    }
  }

  // 开关摄像头,1:开;0:关
  mute_Video.onclick = function () {
    if (checkStatus()) {
      return false;
    }
    let sid = document.getElementById('publish_video1').name || document.getElementById('publish_streamId1').name;
    if (sid) {
      if (mute_Video.classList.contains('on')) {
        mute_Video.classList.remove('on');
        test_controller.SetLocalVideoEnable(1, parseInt(sid));
      } else {
        mute_Video.classList.add('on');
        test_controller.SetLocalVideoEnable(0, parseInt(sid));
      }
    }
  };

  //状态检查
  function checkStatus() {
    if (conn_state == 0) {
      alert("请先建立连接");
      return true;
    }

    if (room_state == 0) {
      alert("当前不在房间中");
      return true;
    }
  }

  // 本地截图
  takePictureBtn.onclick = function () {
    let sid = document.getElementById('publish_video1').name;
    let local_picture_type = document.getElementById("local_picture_type").value;
    if (!sid) {
      //纯音频的时候sid在publish_streamId标签中
      alert("纯音频不可截屏");
      return;
    }
    if (sid) {
      let data = test_controller.TakePicture(0, undefined, undefined, parseInt(sid), parseInt(
        local_picture_type));
      let img_local = document.getElementById("previewImg");
      img_local.style.visibility = "visible";
      img_local.src = data;
    } else {
      alert("当前不在音视频通话中");
    }
  };

  //远端截图
  window.takePictureRemoteBtn = function (sid, remote_picture_type) {
    if (!sid) {
      alert("当前不在音视频通话中");
      return;
    }
    let data = test_controller.TakePicture(1, undefined, undefined, parseInt(sid), parseInt(
      remote_picture_type));
    let img_remote = document.getElementById("previewImgRemote");
    img_remote.style.visibility = "visible";
    img_remote.src = data;
  }
  function receiveDataOrText(uid, msg) {
    let nodeP = document.createElement('p');
    let nodeSpan = document.createElement('span');
    nodeP.classList.add('dialogue-service-contain');
    nodeSpan.classList.add('dialogue-text', 'dialogue-service-text');
    nodeSpan.innerHTML = uid + ":" + msg;
    nodeP.appendChild(nodeSpan);
    dialogueContain.appendChild(nodeP);
    dialogueContain.scrollTop = dialogueContain.scrollHeight;
  }
  //收到对端文字消息
  test_controller.OnReceiveTextMsg = function (uid, msg) {
    let reg = /http:\/\/.*?(gif|png|jpg|jpeg|bmp)/gi;
    // 判断是否图片
    if (msg.match(reg)) {
      let nodeP = document.createElement('p');
      let nodeA = document.createElement('a');
      let nodeImg = document.createElement('img');
      nodeA.setAttribute("href", msg);
      nodeImg.setAttribute("src", msg);
      nodeP.classList.add('dialogue-service-contain');
      nodeImg.classList.add('dialogue-text', 'dialogue-service-text');
      nodeA.appendChild(nodeImg);
      nodeP.appendChild(nodeA);
      dialogueContain.appendChild(nodeP);
      dialogueContain.scrollTop = dialogueContain.scrollHeight;
    } else {
      receiveDataOrText(uid, msg)
    }
  };

  test_controller.OnReceiveData = function (data) {
    receiveDataOrText(otherUid, data)
  }
  // 聊天功能相关
  let dialogueInput = document.getElementById('dialogue_input'),
    dialogueContain = document.getElementById('dialogue_contain'),
    dialogueHint = document.getElementById('dialogue_hint'),
    btnOpen = document.getElementById('btn_open'),
    btnClose = document.getElementById('btn_close'),
    timer,
    timerId,
    shiftKeyOn = false; // 辅助判断shift键是否按住


  btnOpen.addEventListener('click', function (e) {
    if (checkStatus()) {
      return false;
    }
    $('.dialogue-support-btn').css({
      'display': 'none'
    });
    $('.dialogue-main').css({
      'display': 'inline-block',
      'height': '0'
    });
    $('.dialogue-main').animate({
      'height': '600px'
    })

  });

  btnClose.addEventListener('click', function (e) {
    $('.dialogue-main').animate({
      'height': '0'
    }, function () {
      $('.dialogue-main').css({
        'display': 'none'
      });
      $('.dialogue-support-btn').css({
        'display': 'inline-block'
      });
    });
  });

  dialogueInput.addEventListener('keydown', function (e) {

    var e = e || window.event;
    if (e.keyCode == 16) {
      shiftKeyOn = true;
    }
    if (shiftKeyOn) {
      return true;
    } else if (e.keyCode == 13 && dialogueInput.value == '') {
      // console.log('发送内容不能为空');
      // 多次触发只执行最后一次渐隐
      setTimeout(function () {
        fadeIn(dialogueHint);
        clearTimeout(timerId)
        timer = setTimeout(function () {
          fadeOut(dialogueHint)
        }, 2000);
      }, 10);
      timerId = timer;
      return true;
    } else if (e.keyCode == 13) {
      let reg = /http:\/\/.*?(gif|png|jpg|jpeg|bmp)/gi;
      // 判断是否图片
      if (dialogueInput.value.match(reg)) {
        let nodeP = document.createElement('p');
        let nodeA = document.createElement('a');
        let nodeImg = document.createElement('img');
        nodeA.setAttribute("href", dialogueInput.value);
        nodeImg.setAttribute("src", dialogueInput.value);
        nodeP.classList.add('dialogue-customer-contain');
        nodeImg.classList.add('dialogue-text', 'dialogue-customer-text');
        nodeA.appendChild(nodeImg);
        nodeP.appendChild(nodeA);
        dialogueContain.appendChild(nodeP);
        dialogueContain.scrollTop = dialogueContain.scrollHeight;
      } else {
        let nodeP = document.createElement('p');
        let nodeSpan = document.createElement('span');
        nodeP.classList.add('dialogue-customer-contain');
        nodeSpan.classList.add('dialogue-text', 'dialogue-customer-text');
        nodeSpan.innerHTML = dialogueInput.value;
        nodeP.appendChild(nodeSpan);
        dialogueContain.appendChild(nodeP);
        dialogueContain.scrollTop = dialogueContain.scrollHeight;
      }
      if ($('#enableDataChannel').prop("checked")) {
        test_controller.SendData(dialogueInput.value);
      } else {
        test_controller.SendTextMsg(dialogueInput.value);
      }
    }
  });

  dialogueInput.addEventListener('keyup', function (e) {
    var e = e || window.event;
    if (e.keyCode == 16) {
      shiftKeyOn = false;
      return true;
    }
    if (!shiftKeyOn && e.keyCode == 13) {
      dialogueInput.value = null;
    }
  });

  // 渐隐
  function fadeOut(obj) {
    let n = 100;
    let time = setInterval(function () {
      if (n > 0) {
        n -= 10;
        obj.style.opacity = '0.' + n;
      } else if (n <= 30) {
        obj.style.opacity = '0';
        clearInterval(time);
      }
    }, 10);
    return true;
  }

  // 渐显
  function fadeIn(obj) {
    let n = 30;
    let time = setInterval(function () {
      if (n < 90) {
        n += 10;
        obj.style.opacity = '0.' + n;
      } else if (n >= 80) {

        obj.style.opacity = '1';
        clearInterval(time);
      }
    }, 100);
    return true;
  }


  //~~~~录制相关~~~~~~~~
  let record_id = 0;

  //获取浏览器录制id
  function getRecordId() {
    return ++record_id;
  }


  //获取sids
  function getSidsInfo() {
    //发布的sid
    let publish_sid = document.getElementById('publish_video1').name || document.getElementById('publish_streamId1').name;
    //订阅的sid
    let subscribe_sids = [];
    let subscribe_sid, subscribe_sid1, subscribe_sid2;
    if (duet) {
      subscribe_sid = document.getElementById('video0').name || document.getElementById('audio0').name;
    } else {
      subscribe_sid = document.getElementById('video1').name || document.getElementById('audio1').name;
      subscribe_sid1 = document.getElementById('video2').name || document.getElementById('audio2').name;
      subscribe_sid2 = document.getElementById('video3').name || document.getElementById('audio3').name;
    }
    if (subscribe_sid) {
      subscribe_sids.push(subscribe_sid)
    };
    if (subscribe_sid1) {
      subscribe_sids.push(subscribe_sid1)
    };
    if (subscribe_sid2) {
      subscribe_sids.push(subscribe_sid2)
    }
    return {
      publish_sid,
      subscribe_sids,
    };
  }

  let localRecordStatus = false;
  let watermarkStr = [`
        <div class="watermark_head" data-type="timestamp">
          <!-- 时间戳水印 -->
          &nbsp;<label>时间戳水印</label>&nbsp;
          <label text="watermark_time_id">水印id:</label>
          <input type="number" value=1 style="width:50px;" class="watermark_id">
          <label text="watermark_time_x">x坐标:</label>
          <input class="inputNumber" type="number" value=0 style="width:50px;">
          <label text="watermark_time_y">y坐标:</label>
          <input class="inputNumber" type="number" value=0 style="width:50px;">
          <label>Tag:</label>
          <input type="text" class="watermark_tag">
          <button class="deleteWatermark">删除</button>
        </div>`,
    `
        <div class="watermark_head" data-type="text">
          <!-- 文字水印 -->
          &nbsp;<label>文字水印</label>&nbsp;&nbsp;&nbsp;&nbsp;
          <label text="watermark_text_id">水印id:</label>
          <input type="number" value=2 style="width:50px;" class="watermark_id">
          <label text="watermark_text_x">x坐标:</label>
          <input class="inputNumber" type="number" value=0 style="width:50px;">
          <label text="watermark_text_y">y坐标:</label>
          <input class="inputNumber" type="number" value=0 style="width:50px;">
          <label text="watermark_text_body">文本内容:</label>
          <input type="text" id="watermark_text_body" value="MRTC录制" style="width:80px;">
          <label text="watermark_text_font">字体大小:</label>
          <input class="inputNumber" type="number" value=20>
          <label>Tag:</label>
          <input type="text" class="watermark_tag">
          <button class="deleteWatermark">删除</button>
        </div>`,
    `
        <div class="watermark_head" data-type="picture">
          <!-- 图片水印 -->
          &nbsp;<label>图片水印</label>&nbsp;&nbsp;&nbsp;&nbsp;
          <label text="watermark_pic_id">水印id:</label>
          <input type="number" value=3 style="width:50px;" class="watermark_id">
          <label text="watermark_pic_x">x坐标:</label>
          <input class="inputNumber" type="number" value=0 style="width:50px;">
          <label text="watermark_pic_y">y坐标:</label>
          <input class="inputNumber" type="number" value=0 style="width:50px;">
          <label text="watermark_pic_url">图片地址:</label>
          <input type="text" style="width:200px;" />
          <label class="watermark_tag_label">Tag:</label>
          <input type="text" class="watermark_tag">

          <button class="deleteWatermark">删除</button>
        </div>`]
  let watermarkId = 0;
  $(".addWatermark").on("click", function (e) {
    watermarkId++
    let type = $(this).data("type").split("-");
    if (type[0] == 1) {
      $("#client_watermark").append(watermarkStr[type[1]]);
      if (type[1] == 2) {
        $(`<input type="file" name="选择本地文件" style="width:150px;" />`).insertBefore("#client_watermark .watermark_head:last-child .watermark_tag_label")
      }
      $("#client_watermark .watermark_head:last-child .watermark_id").val(watermarkId)
    } else {
      $("#watermark").append(watermarkStr[type[1]]);
      $("#watermark .watermark_head:last-child .watermark_id").val(watermarkId)

    }
  })
  $("body").on("click", ".deleteWatermark", function (e) {
    $(this).parent().remove()
  });
  let tagPositionStr = `<div class="tag_position"><label text="tag_position">TAG对应布局:</label>
          <input type="text" class="tag" style="width:150px;"/>&nbsp;
          <label text="tag_position_x">x坐标:</label>
          <input type="text" class="tag_position_x" style="width:30px;" />
          <label text="tag_position_y">y坐标:</label>
          <input type="text" class="tag_position_y" style="width:30px;" />
          <label text="tag_position_width">宽:</label>
          <input type="text" class="tag_position_width" style="width:30px;" />
          <label text="tag_position_height">高:</label>
          <input type="text" class="tag_position_height" style="width:30px;" />
          <button class="deleteTagPosition">删除</button>
          </div>`
  $("#addTagPosition").on("click", function (e) {
    $("#tagPosition").append(tagPositionStr);
  });
  $("body").on("click", ".deleteTagPosition", function (e) {
    $(this).parent().remove()
  });

  // 开始浏览器录制
  btnStartRecording.onclick = function () {
    if (checkStatus()) {
      return false;
    }
    let {
      publish_sid,
      subscribe_sids
    } = getSidsInfo();
    let video_profile = {};
    video_profile.videoCodec = document.getElementById("record_videoCodec").value;
    video_profile.frameRate = parseInt(document.getElementById("record_frameRate").value);
    let media_type = document.getElementById("select_record_media_type").value;
    let time_slice = document.getElementById("record_timeSlice").value;
    let recordResolution = document.querySelector('#browserRecordResolution').value;
    let record_config = {};
    record_config.media_type = parseInt(media_type);
    record_config.time_slice = time_slice;
    record_config.video_profile = video_profile;
    record_config.record_resolution = recordResolution;
    let stream_list = [];
    if (publish_sid) {
      stream_list.push(publish_sid);
    }
    if (subscribe_sids.length) {
      stream_list = stream_list.concat(subscribe_sids);
    }
    let client_record_id = getRecordId();

    //水印
    let wmCount = $("#client_watermark .watermark_head");
    let overlaps = [];

    for (let i = 0; i < wmCount.length; i++) {
      let type = $(wmCount[i]).data("type");
      let arr = $(wmCount[i]).children("input");
      let wm
      if (type == "timestamp") {
        // 时间戳水印
        wm = {
          enable: true,
          type: 1,
          id: +arr.eq(0).val(),
          xPosition: +arr.eq(1).val(),
          yPosition: +arr.eq(2).val(),
          tag: arr.eq(3).val()
        };
      } else if (type == "text") {
        // 文字水印
        wm = {
          enable: true,
          type: 2,
          id: +arr.eq(0).val(),
          xPosition: +arr.eq(1).val(),
          yPosition: +arr.eq(2).val(),
          text: arr.eq(3).val(),
          fontSize: +arr.eq(4).val(),
          tag: arr.eq(5).val()
        }
      } else {
        // 图片水印
        let waterMarkImage = new Image();
        let url;
        if (arr.eq(3).val() && arr.eq(4).prop("files").length) {
          alert("选择本地图片或者网络图片")
          return
        } else if (!arr.eq(3).val() && !arr.eq(4).prop("files").length) {
          alert("请选择一个图片")
          return
        } else if (arr.eq(3).val()) {
          waterMarkImage.crossOrigin = 'anonymous';
          url = arr.eq(3).val();
        } else if (arr.eq(4).prop("files").length) {
          url = URL.createObjectURL(arr.eq(4).prop("files")[0]);
        }
        waterMarkImage.src = url;
        wm = {
          enable: true,
          type: 3,
          id: +arr.eq(0).val(),
          xPosition: +arr.eq(1).val(),
          yPosition: +arr.eq(2).val(),
          img: waterMarkImage,
          tag: arr.eq(5).val()
        }
      }
      overlaps.push(wm)

    };
    console.log(overlaps)
    // 水印封装
    record_config.overlaps = overlaps;
    // 清晰度
    record_config.crf = parseInt(document.getElementById("record_crf").value);
    test_controller.StartBrowserRecord(client_record_id, stream_list, record_config);
  };

  //暂停浏览器录制
  btnPauseRecording.onclick = function () {
    let client_record_id = document.getElementById("client_record_id").innerText;
    if (!client_record_id) {
      alert("未开启浏览器录制");
      return;
    }
    if (localRecordStatus && client_record_id) {
      test_controller.PauseRecord(parseInt(client_record_id));
    }
  };
  //恢复浏览器录制
  btnResumeRecording.onclick = function () {
    let client_record_id = document.getElementById("client_record_id").innerText;
    if (!client_record_id) {
      alert("未开启浏览器录制");
      return;
    }
    if (localRecordStatus && client_record_id) {
      test_controller.ResumeRecord(parseInt(client_record_id));
    }
  };
  //停止浏览器录制
  btnStopRecording.onclick = function () {
    let client_record_id = document.getElementById("client_record_id").innerText;
    if (!client_record_id) {
      alert("未开启浏览器录制");
      return;
    }
    if (localRecordStatus && client_record_id) {
      test_controller.StopRecord(parseInt(client_record_id));
    }
  };

  //下载浏览器录制音视频
  btnDownloadRecording.onclick = function () {
    let client_record_id = document.getElementById("client_record_id").innerText;
    if (!client_record_id) {
      alert("当前不在音视频通话中");
      return;
    }
    if (client_record_id) {
      test_controller.DownloadRecord(parseInt(client_record_id), `file_${client_record_id}`);
    }
  };

  //开启浏览器录制成功
  test_controller.OnClientStartRecordSuccess = function (clientRecordId) {
    test_controller.trace(`~~~~~~~~~~~~~ OnClientRecordSuccess,clientRecordId=${clientRecordId}`);
    localRecordStatus = true;
    document.getElementById("client_record_id").innerText = clientRecordId;
  };

  //停止浏览器录制成功回调
  test_controller.OnClientStopRecordSuccess = function (url, blob, clientRecordId) {
    this.trace(
      `OnClientStopRecordSuccess: video url = ${url},blobSize=${blob.size} clientRecordId = ${clientRecordId}`
    );
    if (blob) {
      localRecordStatus = false;
      let clientRecordPreview = document.getElementById("clientRecordPreview");
      clientRecordPreview.src = URL.createObjectURL(blob);
    } else {
      console.debug("local blob is null");
    }
  };

  test_controller.OnClientStartRecordFailed = function (clientRecordId, code, msg) {
    test_controller.warning(
      `~~~~~~~~~~~~~ OnClientStartRecordFailed,clientRecordId=${clientRecordId},code=${code},msg=${msg}`
    );
  };

  test_controller.OnClientStopRecordFailed = function (clientRecordId, code, msg) {
    test_controller.warning(
      `~~~~~~~~~~~~~ OnClientStopRecordFailed,clientRecordId=${clientRecordId},code=${code},msg=${msg}`
    );
  };

  test_controller.OnClientDownloadRecordSuccess = function (clientRecordId) {
    test_controller.trace(`~~~~~~~~~~~~~ OnClientDownloadRecordSuccess,clientRecordId=${clientRecordId}`);
  };

  test_controller.OnClientDownloadRecordFailed = function (clientRecordId, code, msg) {
    test_controller.warning(
      `~~~~~~~~~~~~~ OnClientDownloadRecordFailed,clientRecordId=${clientRecordId},code=${code},msg=${msg}`
    );
  };

  test_controller.OnClientPauseRecordSuccess = function (clientRecordId) {
    test_controller.trace(`~~~~~~~~~~~~~ OnClientPauseRecordSuccess,clientRecordId=${clientRecordId}`);
  };

  test_controller.OnClientPauseRecordFailed = function (clientRecordId, code, msg) {
    test_controller.warning(
      `~~~~~~~~~~~~~ OnClientPauseRecordFailed,clientRecordId=${clientRecordId},code=${code},msg=${msg}`
    );
  };

  test_controller.OnClientResumeRecordSuccess = function (clientRecordId) {
    test_controller.trace(`~~~~~~~~~~~~~ OnClientResumeRecordSuccess,clientRecordId=${clientRecordId}`);
  };

  test_controller.OnClientResumeRecordFailed = function (clientRecordId, code, msg) {
    test_controller.warning(
      `~~~~~~~~~~~~~ OnClientResumeRecordFailed,clientRecordId=${clientRecordId},code=${code},msg=${msg}`
    );
  };


  //################服务端录制########################
  //开始服务端录制
  window.startRemoteRecordBtn = function () {
    if (checkStatus()) {
      return false;
    }
    document.getElementById("status").innerText = "";
    document.getElementById("fileType").innerText = "";
    document.getElementById("filePath").innerText = "";

    let recordTag = $("#recordTag").val();
    let filePath = $("#record_filePath").val();
    let recordParam = {};
    recordParam.silentRecord = document.getElementById("silentRecord").checked;
    recordParam.width = parseInt($("#record_width").val());
    recordParam.height = parseInt($("#record_height").val());
    recordParam.recordTotalStream = parseInt($("#record_total_stream").val());
    recordParam.startTimeout = parseInt($("#record_timeout").val());
    recordParam.splitType = parseInt($("#record_splitType").val());
    recordParam.splitFilePath = $("#record_splitFilePath").val();
    recordParam.endType = parseInt($("#record_endType").val());
    recordParam.layoutParam = $("#record_layoutParam").val().split(',');
    recordParam.tagFilter = $("#tag_filter").val();

    //水印
    let wmCount = $("#watermark .watermark_head");
    let overlaps = [];

    for (let i = 0; i < wmCount.length; i++) {
      let type = $(wmCount[i]).data("type");
      let arr = $(wmCount[i]).children("input");
      let wm
      if (type == "timestamp") {
        // 时间戳水印
        wm = {
          enable: true,
          type: 1,
          id: +(arr.eq(0).val()),
          xPosition: +(arr.eq(1).val()),
          yPosition: +(arr.eq(2).val()),
          tag: arr.eq(3).val()
        };
      } else if (type == "text") {
        // 文字水印
        wm = {
          enable: true,
          type: 2,
          id: +arr.eq(0).val(),
          xPosition: +arr.eq(1).val(),
          yPosition: +arr.eq(2).val(),
          text: arr.eq(3).val(),
          fontSize: +arr.eq(4).val(),
          tag: arr.eq(5).val()
        }
      } else {
        // 图片水印
        let url;
        if (!arr.eq(3).val()) {
          alert("请选择一个图片")
          return
        }
        wm = {
          enable: true,
          type: 3,
          id: +arr.eq(0).val(),
          xPosition: +arr.eq(1).val(),
          yPosition: +arr.eq(2).val(),
          url: arr.eq(3).val(),
          tag: arr.eq(4).val()
        }
      }
      overlaps.push(wm)
    };

    // 水印封装
    recordParam.overlaps = overlaps;
    // 清晰度
    recordParam.crf = parseInt(document.getElementById("record_crf").value);
    // tag布局
    let tagPositions = [];
    // tag1
    let tags_div = $("#tagPosition .tag_position");
    for (let i = 0; i < tags_div.length; i++) {
      let inputArr = $(tags_div[i]).children("input");
      let tagParam = {
        tag: inputArr.eq(0).val(),
        xPosition: Number(inputArr.eq(1).val()),
        yPosition: Number(inputArr.eq(2).val()),
        width: Number(inputArr.eq(3).val()),
        height: Number(inputArr.eq(4).val())
      }
      tagPositions.push(tagParam);
    }
    recordParam.tagPositions = tagPositions;

    test_controller.StartRemoteRecord(filePath, recordParam, recordTag);
  }

  //开始服务端录制成功回调,recordId为服务端录制id
  test_controller.OnStartRemoteRecordSucc = function (recordId, recordTag) {
    test_controller.trace(`OnStartRemoteRecordSucc recordId=${recordId}, recordTag=${recordTag}`);
    $('#remoteRecordIDList').append(`<option value="${recordId}">${recordId}</option>`)
    document.getElementById("remote_server_record_id").innerText = recordId;
    document.getElementById("remote_server_record_id").style.color = 'rgba(219, 87, 51, 1)';
  };
  //暂停服务端录制,recordId为服务端录制id
  window.pauseRemoteRecordBtn = function (recordId) {
    if (!recordId) {
      alert("请先点击开始远端录制");
      return;
    }
    test_controller.PauseRemoteRecord(recordId);
  }
  //恢复服务端录制,recordId为服务端录制id
  window.resumeRemoteRecordBtn = function (recordId) {
    if (!recordId) {
      alert("请先点击开始远端录制");
      return;
    }
    test_controller.ResumeRemoteRecord(recordId);
  }
  //变更服务器录制水印,recordId为服务端录制id
  window.changeRecordWatermark = function (recordId) {
    if (!recordId) {
      alert("请先点击开始远端录制");
      return;
    }
    //水印
    let wmCount = $("#watermark .watermark_head");
    let overlaps = [];

    for (let i = 0; i < wmCount.length; i++) {
      let type = $(wmCount[i]).data("type");
      let arr = $(wmCount[i]).children("input");
      let wm
      if (type == "timestamp") {
        // 时间戳水印
        wm = {
          enable: true,
          type: 1,
          id: +(arr.eq(0).val()),
          xPosition: +(arr.eq(1).val()),
          yPosition: +(arr.eq(2).val()),
          tag: arr.eq(3).val()
        };
      } else if (type == "text") {
        // 文字水印
        wm = {
          enable: true,
          type: 2,
          id: +arr.eq(0).val(),
          xPosition: +arr.eq(1).val(),
          yPosition: +arr.eq(2).val(),
          text: arr.eq(3).val(),
          fontSize: +arr.eq(4).val(),
          tag: arr.eq(5).val()
        }
      } else {
        // 图片水印
        let url;
        if (!arr.eq(3).val()) {
          alert("请选择一个图片")
          return
        }
        wm = {
          enable: true,
          type: 3,
          id: +arr.eq(0).val(),
          xPosition: +arr.eq(1).val(),
          yPosition: +arr.eq(2).val(),
          url: arr.eq(3).val(),
          tag: arr.eq(4).val()
        }
      }
      overlaps.push(wm)
    };
    test_controller.ChangeRemoteRecordWatermark(recordId, overlaps);
  }
  //停止服务端录制,recordId为服务端录制id
  window.stopRemoteRecordBtn = function (recordId) {
    if (!recordId) {
      alert("请先点击开始远端录制");
      return;
    }
    test_controller.StopRemoteRecord(recordId);
  }

  //获取服务端录制信息
  window.queryRemoteRecord = function (recordId) {

    //若在离开房间后调用,需自行管理room_id和recordId
    let roomId = $("#room_id").val();
    let recordMediaType = parseInt($("#record_media_type").val());
    if (!recordId || !roomId) {
      alert("参数不对");
      return;
    }
    test_controller.GetRecordInfo(recordId, roomId, recordMediaType, getSign(recordId, true));
  }

  //获取服务端录制信息回调
  test_controller.OnRecordInfoSucc = function (recordInfo) {
    test_controller.trace(`~~~~~~~~~~~~~ GetRecordInfo succ: recordInfo = ${JSON.stringify(recordInfo)}`);
    let status = recordInfo.status;
    let fileType = recordInfo.fileType;
    let filePath = recordInfo.filePath;

    switch (status) {
      case 0:
        status = "录制中";
        break;
      case 1:
        status = "上传中";
        break;
      case 2:
        status = "录制成功";
        break;
      case 3:
        status = "录制失败";
        break;
      default:
        break;
    }

    switch (fileType) {
      case 1:
        fileType = "本地文件";
        break;
      case 2:
        fileType = "OSS";
        break;
      case 3:
        fileType = "AFTS";
        break;
      default:
        break;
    }

    document.getElementById("status").innerText = "status:" + status;
    if (fileType) {
      document.getElementById("fileType").innerText = "fileType:" + fileType;
    }
    if (filePath) {
      document.getElementById("filePath").innerText = filePath;
    }

  };

  // 视屏全屏
  window.requestFullScreen = function (element) {
    let requestMethod = element.requestFullScreen || //W3C
      element.webkitRequestFullScreen || //Chrome等
      element.mozRequestFullScreen || //FireFox
      element.msRequestFullScreen; //IE11
    if (requestMethod) {
      requestMethod.call(element);
    } else if (typeof window.ActiveXObject !== "undefined") {
      //for Internet Explorer
      let wscript = new ActiveXObject("WScript.Shell");
      if (wscript !== null) {
        wscript.SendKeys("{F11}");
      }
    }
  }

  //退出全屏(暂时不需要这个按钮)
  function exitFull() {
    var exitMethod = document.exitFullscreen || //W3C
      document.mozCancelFullScreen || //Chrome等
      document.webkitExitFullscreen || //FireFox
      document.webkitExitFullscreen; //IE11
    if (exitMethod) {
      exitMethod.call(document);
    } else if (typeof window.ActiveXObject !== "undefined") { //for Internet Explorer
      var wscript = new ActiveXObject("WScript.Shell");
      if (wscript !== null) {
        wscript.SendKeys("{F11}");
      }
    }
  }

  //获取音量实时数据,音量可视化
  test_controller.OnVolumeAnalyser = function (sid, analyser) {
    let publish_sid = document.getElementById('publish_video1').name || document.getElementById('publish_streamId1').name;
    let volumeView;
    if (sid == publish_sid) {
      volumeView = "publish_volumeView";
    } else {
      for (let i = 0; i <= subscribeAmount; i++) {
        let subscribeId = document.getElementById('video' + i).name || document.getElementById('audio' + i).name;
        if (sid == subscribeId) {
          volumeView = "subscribe_volumeView" + i
          break;
        }
      }
    }

    if (!volumeView) {
      return;
    }
    let canvas = document.getElementById(volumeView);
    let ctx = canvas.getContext("2d");

    let outcanvas = document.createElement("canvas");
    outcanvas.width = canvas.width;
    outcanvas.height = canvas.height;
    ctx.strokeStyle = "#FF4500";
    ctx.lineWidth = 2;
    ctx.clearRect(0, 0, canvas.width, canvas.height); //清理画布
    let dataArray = new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(dataArray);
    let step = Math.round(dataArray.length / 60); //采样步长
    for (var i = 0; i < 40; i++) {
      let energy = (dataArray[step * i] / 256.0) * 50;
      for (var j = 0; j < energy; j++) {
        ctx.beginPath();
        ctx.moveTo(20 * i + 2, 200 + 4 * j);
        ctx.lineTo(20 * (i + 1) - 2, 200 + 4 * j);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(20 * i + 2, 200 - 4 * j);
        ctx.lineTo(20 * (i + 1) - 2, 200 - 4 * j);
        ctx.stroke();
      }
      ctx.beginPath();
      ctx.moveTo(20 * i + 2, 200);
      ctx.lineTo(20 * (i + 1) - 2, 200);
      ctx.stroke();
    }

    //制造半透明投影
    function draw() {
      ctx.drawImage(outcanvas, 0, 0);
      ctx.save();
      ctx.translate(canvas.width / 2, canvas.height / 2);
      ctx.rotate(Math.PI);
      ctx.scale(-1, 1);
      ctx.drawImage(outcanvas, -canvas.width / 2, -canvas.height / 2);
      ctx.restore();
      ctx.fillStyle = 'rgba(192,192,192, .8)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    draw();
    requestAnimationFrame(test_controller.OnVolumeAnalyser.bind(this, sid, analyser));
  };

  // 开启点播
  window.startVod = function (vodFile) {
    let vodParams = {};
    if (checkStatus()) {
      return false;
    }
    if (!vodFile) {
      alert("点播文件不能为空");
      return false;
    }
    if (vod_state == 1) {
      alert("已开启点播");
      return false;
    }
    let vodStartTimeout = parseInt($("#vod_timeout").val());
    vodParams.vodFile = vodFile;
    vodParams.vodStartTimeout = vodStartTimeout;
    test_controller.StartVod(vodParams);
  }

  test_controller.OnStartVodSuccess = function (file, vodId) {
    vod_state = 1;
    document.getElementById("vod_id").innerText = vodId;
    document.getElementById("vod_id").style.color = 'rgba(219, 87, 51, 1)';
  };

  // 停止点播
  window.stopVod = function () {
    let vodId = $("#vod_id").text();
    if (checkStatus()) {
      return false;
    }
    if (!vodId || vod_state == 0) {
      alert("未开启点播");
      return false;
    }
    test_controller.StopVod(vodId);
  }

  //停止点播成功
  test_controller.OnStopVodSuccess = function (vodId) {
    vod_state = 0;
    document.getElementById("vod_id").style.color = '#808080';
  };

  //推送点播结束
  test_controller.OnVodOver = function (vodId) {
    vod_state = 0;
    document.getElementById("vod_id").style.color = '#808080';
  };

  //错误日志上报
  window.downloadLog = function () {
    test_controller.DownloadLog();
  }

  // 初始化手机端日志组件
  window.mobileLog = function () {
    eruda.init();
  }

  //录制通知
  test_controller.OnStartRecordFailed = function (recordId, err_code, msg) {
    test_controller.warning(`OnStartRecordFailed recordId=${recordId}, code=${err_code},msg=${msg}`);
    alert(`err_code=${err_code},msg=${msg}`);
  };

  //录制过程中失败
  test_controller.OnRecordingFailed = function (recordId, feedId, code, msg) {
    test_controller.warning(
      `OnRecordingFailed recordId= ${recordId},feedId= ${feedId}, code= ${code},msg= ${msg}`);
    alert(`err_code=${code},msg=${msg}`);
  };

  //停止录制成功
  test_controller.OnStopRecordSucc = function (recordId) {
    document.getElementById("remote_server_record_id").style.color = '#808080';
  };

  //切流
  window.streamChange = async function (count) {
    if (checkStatus()) {
      return false;
    }
    // publish_device值说明如下
    //1 stream  摄像头
    //2 stream  共享桌面
    //3 stream  文件流
    //4 stream  共享自定义区域
    let sid = document.getElementById('publish_video' + count).name || document.getElementById('publish_streamId' + count).name;

    let publish_config = {};
    let publishDevice = parseInt($("#publish_device" + count).val());
    publish_config.publish_device = publishDevice;
    publish_config.enableVideo = $('#enableVideo').prop("checked");
    publish_config.enableAudio = $('#enableAudio').prop("checked");
    publish_config.enableDatachannel = $('#enableDatachannel').prop("checked");
    publish_config.sid = sid;
    setMediaInfo(publish_config);

    //分辨率切换
    let video_profile_type = $("#video_profile_type").val();
    publish_config.video_profile_type = video_profile_type;
    if (video_profile_type == 100) {
      publish_config.video_profile_diy = {
        width: +$("#video_profile_diy_width").val(),
        height: +$("#video_profile_diy_height").val(),
        frameRate: +$("#video_profile_diy_framerate").val(),
        bitrate: +$("#video_profile_diy_bitrate").val()
      }
    }


    if (publishDevice == 2) {
      publish_config.enableDesktopAudio = $("#enableDesktopAudio").prop("checked");

    } else if (publishDevice == 3) {
      let file = document.getElementById('v_file' + count).files[0];
      if (!file) {
        alert("未选择文件");
        return;
      }
      publish_config.file = file;
      publish_config.draw_file_video_2_canvas = document.getElementById('draw_file_video_2_canvas').checked;

    } else if (publishDevice == 4) {
      publish_config.part_of_screen_id = "a2";
      let partOfScreenId = publish_config.part_of_screen_id;
      let elementById = document.getElementById(partOfScreenId);
      if (!partOfScreenId || !elementById) {
        alert("未选定共享区域");
        return;
      }

    } else if (publishDevice == 5) {
    }

    let stream = test_controller.ChangeMediaStream(publish_config);
  }

  //动态切流
  function changeStream() {
    let sid = document.getElementById('publish_video1').name || document.getElementById('publish_streamId1').name;
    publish_device = parseInt($("#publish_device").val());
    let video_profile_type = $("#video_profile_type").val();

    //先只支持摄像头的切换
    if (sid && publish_device == 1) {
      let config = {};
      config.sid = sid;
      config.video_profile_type = video_profile_type;
      if (video_profile_type == 100) {
        config.video_profile_diy = {
          width: $("#video_profile_diy_width").val(),
          height: $("#video_profile_diy_height").val(),
          frameRate: $("#video_profile_diy_framerate").val(),
          bitrate: +$("#video_profile_diy_bitrate").val()
        }
      }
      setMediaInfo(config);
      test_controller.ChangeProfile(config);
    }
  }

  //动态切换分辨率
  $("#video_profile_type").change(function () {
    let sid = document.getElementById('publish_video1').name || document.getElementById('publish_streamId1').name;
    let video_profile_type = $(this).val();
    let video_profile_diy = {};
    if (video_profile_type == 100) {
      video_profile_diy = {
        width: $("#video_profile_diy_width").val(),
        height: $("#video_profile_diy_height").val(),
        frameRate: $("#video_profile_diy_framerate").val(),
        bitrate: +$("#video_profile_diy_bitrate").val()
      }
    }
    test_controller.ChangeStreamSize(sid, video_profile_type, video_profile_diy);
  })

  //动态切换编码格式
  $("#select_codec").change(function () {
    let sid = document.getElementById('publish_video1').name || document.getElementById('publish_streamId1').name;
    let codec_type = $(this).val();
    test_controller.ChangeCodecType(sid, codec_type);
  })

  //动态切换麦克风
  $("#audioSource").change(function () {
    changeStream();
  })

  //动态切换摄像头
  $("#videoSource").change(function () {
    changeStream();
  })
  //获取设备信息测试
  function getDevices() {
    test_controller.GetDevices();
  }

  //获取设备成功
  test_controller.OnGetDevicesSuccess = function (devicesInfo) {
    test_controller.trace(JSON.stringify(devicesInfo));
  }

  //获取设备失败
  test_controller.OnGetDevicesFailed = function (code, msg) {
    test_controller.warning(`OnGetDevicesFailed code=${code},msg=${msg}`);
  };

  function generateMediaInfo(sid) {
    let originalMediaInfo = test_controller.GetMediaInfo(sid);
    let mediaInfo = {
      peer_connection_: originalMediaInfo.peer_connection_,
      local_video_width: originalMediaInfo.local_video_width,
      local_video_height: originalMediaInfo.local_video_height,
      local_video_frame: originalMediaInfo.local_video_frame,
      local_video_bitrate: originalMediaInfo.local_video_bitrate,
      stat_interval_: 2,
      video_send_packets_base_: 0,
      video_recv_packets_base_: 0,
      video_send_lost_pack_base_: 0,
      video_recv_lost_pack_base_: 0,
      audio_send_packets_base_: 0,
      audio_recv_packets_base_: 0,
      audio_send_lost_pack_base_: 0,
      audio_recv_lost_pack_base_: 0,
      video_send_qpsum_base: 0,
      video_send_frame_encoded_base: 0,
      video_recv_qpsum_base: 0,
      video_recv_frame_decoded_base: 0,
      video_send_bitrate_base_: 0,
      video_recv_bitrate_base_: 0,
      audio_send_bitrate_base_: 0,
      audio_recv_bitrate_base_: 0
    };
    return mediaInfo;
  }
</script>
